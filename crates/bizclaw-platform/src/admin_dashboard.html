<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BizClaw â€” Admin Platform</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--surface:#161b22;--border:#30363d;--text:#e6edf3;--muted:#8b949e;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--card:#21262d;--purple:#bc8cff;--cyan:#56d4dd;--orange:#f0883e}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);padding:20px 0;display:flex;flex-direction:column}
.sidebar .logo{padding:0 20px 20px;border-bottom:1px solid var(--border);margin-bottom:10px}
.sidebar .logo h2{font-size:18px;color:var(--accent)}
.sidebar .logo p{font-size:12px;color:var(--muted)}
.sidebar a{display:flex;align-items:center;padding:10px 20px;color:var(--muted);text-decoration:none;font-size:14px;gap:8px;transition:all .15s;cursor:pointer}
.sidebar a:hover,.sidebar a.active{background:var(--card);color:var(--text)}
.sidebar .bottom{margin-top:auto;padding:10px 20px;border-top:1px solid var(--border)}
.sidebar .bottom a{padding:5px 0;font-size:13px}
.main{flex:1;padding:30px;overflow-y:auto}
.main h1{font-size:24px;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:25px}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px}
.stat label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
.stat .val{font-size:28px;font-weight:700}
.stat .val.green{color:var(--green)}.stat .val.red{color:var(--red)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px}
.card h3{font-size:14px;margin-bottom:12px;display:flex;justify-content:space-between}
.card h3 a{color:var(--accent);font-size:12px;text-decoration:none;cursor:pointer}
.tenant-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.tenant-row:last-child{border:none}
.tenant-name{color:var(--accent);font-weight:500;cursor:pointer}
.tenant-slug{color:var(--muted);font-size:12px}
.badge{padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
.badge.running{background:#1a3a2a;color:var(--green)}.badge.stopped{background:#2a2a2a;color:var(--muted)}.badge.error{background:#3a1a1a;color:var(--red)}
.badge.connected{background:#1a3a2a;color:var(--green)}.badge.disconnected{background:#2a2a2a;color:var(--muted)}
.event{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.event:last-child{border:none}
.event .type{font-weight:500}.event .meta{color:var(--muted);font-size:11px}
.event .time{color:var(--muted);font-size:11px;white-space:nowrap}
.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:.15s}
.btn-primary{background:var(--accent);color:#fff}.btn-danger{background:var(--red);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-green{background:var(--green);color:#fff}.btn-purple{background:var(--purple);color:#000}
.btn-sm{padding:5px 10px;font-size:11px}
.hidden{display:none!important}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:30px;min-width:400px;max-width:720px;max-height:85vh;overflow-y:auto}
.modal h2{margin-bottom:15px;display:flex;align-items:center;gap:8px}
.modal label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px;margin-top:10px}
.modal input,.modal select,.modal textarea{width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;font-family:inherit}
.modal textarea{resize:vertical;min-height:60px;font-family:'Menlo','Courier New',monospace;font-size:12px}
.modal .actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}
/* Channel config cards */
.ch-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.ch-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:15px;transition:border-color .2s}
.ch-card:hover{border-color:var(--accent)}
.ch-card .ch-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.ch-card .ch-icon{font-size:22px}
.ch-card .ch-name{font-weight:600;font-size:14px}
.ch-card .ch-status{font-size:11px;padding:2px 8px;border-radius:8px}
.ch-card .ch-fields{font-size:12px;color:var(--muted)}
.ch-card input,.ch-card textarea{margin-top:6px;width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:12px;font-family:inherit}
.ch-card textarea{font-family:'Menlo','Courier New',monospace;min-height:50px;resize:vertical}
.ch-card .ch-actions{display:flex;gap:6px;margin-top:8px}
.toggle{position:relative;display:inline-block;width:38px;height:20px}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:20px;transition:.3s}
.toggle .slider:before{content:'';position:absolute;height:14px;width:14px;left:3px;bottom:3px;background:var(--text);border-radius:50%;transition:.3s}
.toggle input:checked+.slider{background:var(--green)}
.toggle input:checked+.slider:before{transform:translateX(18px)}
.qr-container{text-align:center;padding:15px}
.qr-container img{max-width:200px;border-radius:8px;border:2px solid var(--accent)}
.qr-container p{font-size:12px;color:var(--muted);margin-top:8px}
.toast{position:fixed;top:20px;right:20px;background:var(--green);color:#fff;padding:12px 20px;border-radius:8px;font-size:13px;z-index:200;animation:fadeIn .3s,fadeOut .3s 2.5s}
.toast.error{background:var(--red)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}
@media(max-width:768px){.sidebar{width:60px}.sidebar a span,.sidebar .logo p{display:none}.grid{grid-template-columns:1fr}.ch-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="logo"><h2>BizClaw</h2><p>Admin Platform</p></div>
  <a class="active" href="/dashboard" data-page="dashboard"><span>ğŸ“Š</span> <span>Dashboard</span></a>
  <a href="/tenants" data-page="tenants"><span>ğŸ¢</span> <span>Tenants</span></a>
  <a href="/users" data-page="users"><span>ğŸ‘¥</span> <span>Users</span></a>
  <a href="/audit" data-page="audit"><span>ğŸ“‹</span> <span>Audit Log</span></a>
  <a href="/ollama" data-page="ollama"><span>ğŸ§ </span> <span>Ollama</span></a>
  <div class="bottom"><a href="#" onclick="logout()">â Logout</a></div>
</aside>

<!-- Login Screen -->
<div id="login-screen" style="position:fixed;inset:0;background:var(--bg);z-index:300;display:flex;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:40px;width:380px;text-align:center">
    <h2 style="color:var(--accent);margin-bottom:8px">ğŸ”’ BizClaw Admin</h2>
    <p style="color:var(--muted);font-size:13px;margin-bottom:24px">ÄÄƒng nháº­p Ä‘á»ƒ quáº£n lÃ½ há»‡ thá»‘ng</p>
    <div id="login-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
    <input id="login-email" type="email" placeholder="Email" style="width:100%;padding:10px 14px;margin-bottom:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
    <input id="login-password" type="password" placeholder="Password" style="width:100%;padding:10px 14px;margin-bottom:16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn btn-primary" style="width:100%;padding:12px" onclick="doLogin()">ğŸ”‘ Login</button>
  </div>
</div>

<main class="main">
  <!-- Dashboard -->
  <div id="page-dashboard">
    <h1>ğŸ“Š Dashboard</h1>
    <div class="stats" id="stats-row"></div>
    <div class="grid">
      <div class="card"><h3>âš¡ Tenant Health <a href="#" onclick="showPage('tenants')">View all</a></h3><div id="health-list"></div></div>
      <div class="card"><h3>ğŸ“‹ Recent Activity <a href="#" onclick="showPage('audit')">View all</a></h3><div id="activity-list"></div></div>
    </div>
  </div>
  <!-- Tenants -->
  <div id="page-tenants" class="hidden">
    <h1>ğŸ¢ Tenants <button class="btn btn-outline" onclick="showPage('ollama')" style="margin-left:8px;font-size:12px">ğŸ§  Models (Shared)</button> <button class="btn btn-primary" onclick="showCreateModal()" style="margin-left:auto">+ New Tenant</button></h1>
    <div id="tenants-list"></div>
  </div>
  <!-- Tenant Detail -->
  <div id="page-tenant-detail" class="hidden">
    <h1 style="margin-bottom:4px"><a href="#" onclick="showPage('tenants')" style="color:var(--muted);text-decoration:none">ğŸ¢ Tenants</a> / <span id="detail-tenant-name">â€”</span></h1>
    <div style="display:flex;gap:8px;margin-bottom:20px">
      <button class="btn btn-primary btn-sm detail-tab active" onclick="showDetailTab('overview',this)">ğŸ“‹ Overview</button>
      <button class="btn btn-outline btn-sm detail-tab" onclick="showDetailTab('settings',this)">âš™ï¸ Settings</button>
      <button class="btn btn-outline btn-sm detail-tab" onclick="showDetailTab('agents',this)">ğŸ¤– Agents</button>
      <button class="btn btn-outline btn-sm detail-tab" onclick="showDetailTab('channels',this)">ğŸ“± Channels</button>
      <button class="btn btn-outline btn-sm detail-tab" onclick="showDetailTab('model',this)">ğŸ§  Model</button>
    </div>
    <!-- Overview Tab -->
    <div id="detail-tab-overview">
      <div class="stats" id="detail-stats"></div>
      <div class="card" id="detail-info" style="margin-bottom:15px"></div>
    </div>
    <!-- Settings Tab -->
    <div id="detail-tab-settings" class="hidden">
      <div class="card" style="margin-bottom:15px">
        <h3 style="margin-bottom:12px">âš™ï¸ AI Provider & Model</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">Provider</label>
            <select id="cfg-provider" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
              <option>openai</option><option>anthropic</option><option>ollama</option><option>gemini</option><option>deepseek</option><option>groq</option><option>brain</option><option>llamacpp</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">Model</label>
            <input id="cfg-model" placeholder="gpt-4o-mini" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div>
            <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">API Key</label>
            <input id="cfg-api-key" type="password" placeholder="sk-..." style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
          </div>
          <div>
            <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">API Base URL</label>
            <input id="cfg-api-url" placeholder="https://api.openai.com/v1" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
          </div>
        </div>
      </div>
      <div class="card" style="margin-bottom:15px">
        <h3 style="margin-bottom:12px">ğŸ­ Identity</h3>
        <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">Bot Name</label>
        <input id="cfg-identity-name" placeholder="Sales AI" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;margin-bottom:10px">
        <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">Persona</label>
        <input id="cfg-identity-persona" placeholder="A helpful sales assistant" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;margin-bottom:10px">
        <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">System Prompt</label>
        <textarea id="cfg-identity-prompt" placeholder="You are a helpful AI assistant..." style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;font-family:monospace;min-height:100px;resize:vertical"></textarea>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="saveTenantConfig()">ğŸ’¾ LÆ°u Settings</button>
        <span id="cfg-save-status" style="font-size:12px;color:var(--green);line-height:36px"></span>
      </div>
    </div>
    <!-- Agents Tab -->
    <div id="detail-tab-agents" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
        <p style="font-size:12px;color:var(--muted)">Quáº£n lÃ½ agents cho tenant nÃ y. Má»—i agent cÃ³ provider, model vÃ  system prompt riÃªng.</p>
        <button class="btn btn-primary btn-sm" onclick="showAddAgentForm()">+ ThÃªm Agent</button>
      </div>
      <div id="add-agent-form" class="card hidden" style="margin-bottom:15px">
        <h3 style="margin-bottom:8px">ğŸ¤– New Agent</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
          <div><label style="font-size:11px;color:var(--muted)">Name</label><input id="ag-name" placeholder="sales-bot" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"></div>
          <div><label style="font-size:11px;color:var(--muted)">Role</label><input id="ag-role" value="assistant" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"></div>
          <div><label style="font-size:11px;color:var(--muted)">Provider</label><select id="ag-provider" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"><option>openai</option><option>anthropic</option><option>ollama</option><option>gemini</option><option>deepseek</option><option>groq</option><option>brain</option></select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
          <div><label style="font-size:11px;color:var(--muted)">Model</label><input id="ag-model" placeholder="gpt-4o-mini" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"></div>
          <div><label style="font-size:11px;color:var(--muted)">Description</label><input id="ag-desc" placeholder="Sales assistant" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"></div>
        </div>
        <div style="margin-top:8px"><label style="font-size:11px;color:var(--muted)">System Prompt</label><textarea id="ag-prompt" placeholder="You are..." style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:12px;font-family:monospace;min-height:60px"></textarea></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button class="btn btn-primary btn-sm" onclick="createTenantAgent()">ğŸ’¾ Táº¡o</button>
          <button class="btn btn-outline btn-sm" onclick="document.getElementById('add-agent-form').classList.add('hidden')">Huá»·</button>
        </div>
      </div>
      <div id="agents-list"></div>
    </div>
    <!-- Channels Tab -->
    <div id="detail-tab-channels" class="hidden">
      <p style="font-size:12px;color:var(--muted);margin-bottom:15px">Cáº¥u hÃ¬nh kÃªnh giao tiáº¿p cho Agent. Báº­t/táº¯t vÃ  nháº­p thÃ´ng tin xÃ¡c thá»±c cho tá»«ng kÃªnh.</p>
      <div class="ch-grid" id="detail-ch-grid"></div>
    </div>
    <!-- Model Tab -->
    <div id="detail-tab-model" class="hidden">
      <div class="card" style="margin-bottom:15px">
        <h3 style="margin-bottom:12px">ğŸ§  Model Configuration</h3>
        <p style="font-size:12px;color:var(--muted);margin-bottom:15px">Ollama models are shared across all tenants. Each tenant selects which model to use.<br>If Ollama is not installed on the server, use cloud providers (OpenAI, Anthropic, etc.) instead.</p>
        <div id="detail-model-info"></div>
      </div>
      <div class="card">
        <h3 style="margin-bottom:12px">ğŸ“¦ Available Models (Shared Ollama)</h3>
        <div id="detail-models-list"></div>
        <div style="margin-top:12px;padding:12px;background:var(--card);border-radius:8px;border:1px solid var(--border)">
          <p style="font-size:12px;color:var(--muted)">ğŸ’¡ Má»—i tenant dÃ¹ng chung Ollama server â€” chá»‰ cáº§n pull model 1 láº§n, táº¥t cáº£ tenant Ä‘á»u dÃ¹ng Ä‘Æ°á»£c. RAM Ä‘á»§ náº¿u chá»‰ run 1 model cÃ¹ng lÃºc (~2-4GB cho 7B model).</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Users -->
  <div id="page-users" class="hidden">
    <h1>ğŸ‘¥ Users</h1>
    <div id="users-list"></div>
  </div>
  <!-- Audit -->
  <div id="page-audit" class="hidden">
    <h1>ğŸ“‹ Audit Log</h1>
    <div id="audit-full"></div>
  </div>
  <!-- Ollama / Brain Engine -->
  <div id="page-ollama" class="hidden">
    <h1>ğŸ§  Brain / Ollama Management</h1>
    <div class="stats" style="margin-bottom:20px">
      <div class="stat" id="ollama-health-card"><label>Ollama Status</label><div class="val" id="ollama-status" style="font-size:16px">Checking...</div></div>
      <div class="stat"><label>Total Models</label><div class="val green" id="ollama-count">0</div></div>
      <div class="stat"><label>Ollama URL</label><div class="val" id="ollama-url" style="font-size:14px">â€”</div></div>
    </div>
    <div class="card" style="margin-bottom:15px">
      <h3 style="margin-bottom:12px">ğŸ“¥ Pull Model <span style="font-size:12px;color:var(--muted);font-weight:400">â€” Download from ollama.com</span></h3>
      <div style="display:flex;gap:8px">
        <select id="pull-model-name" style="flex:1;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
          <option value="tinyllama">tinyllama (637 MB)</option>
          <option value="phi3:mini">phi3:mini (2.3 GB)</option>
          <option value="llama3.2:1b">llama3.2:1b (1.3 GB)</option>
          <option value="llama3.2:3b">llama3.2:3b (2.0 GB)</option>
          <option value="qwen2.5:0.5b">qwen2.5:0.5b (397 MB)</option>
          <option value="qwen2.5:1.5b">qwen2.5:1.5b (986 MB)</option>
          <option value="gemma2:2b">gemma2:2b (1.6 GB)</option>
          <option value="deepseek-r1:1.5b">deepseek-r1:1.5b (1.1 GB)</option>
        </select>
        <input id="pull-model-custom" placeholder="Or type custom: mistral:7b" style="flex:1;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
        <button class="btn btn-primary" onclick="pullModel()" id="pull-btn">ğŸ“¥ Pull</button>
      </div>
      <div id="pull-status" style="margin-top:8px;font-size:12px;color:var(--muted);display:none"></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:12px">ğŸ“¦ Installed Models</h3>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Model</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Size</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Family</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Params</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Quant</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Actions</th>
        </tr></thead>
        <tbody id="ollama-models"></tbody>
      </table>
      <div id="ollama-empty" style="text-align:center;padding:24px;color:var(--muted);display:none">
        <p>ğŸ“¥ No models installed yet. Pull one above to get started!</p>
      </div>
    </div>
  </div>
</main>

<!-- Create Tenant Modal -->
<div id="modal-create" class="modal-overlay hidden">
  <div class="modal">
    <h2>Create Tenant</h2>
    <label>Name</label><input id="f-name" placeholder="My Bot">
    <label>Slug (subdomain)</label><input id="f-slug" placeholder="mybot">
    <label>Provider</label>
    <select id="f-provider"><option>openai</option><option>anthropic</option><option>ollama</option><option>gemini</option><option>deepseek</option><option>groq</option><option>brain</option></select>
    <label>Model</label><input id="f-model" value="gpt-4o-mini">
    <label>Plan</label>
    <select id="f-plan"><option>free</option><option>pro</option><option>business</option></select>
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-create')">Cancel</button>
      <button class="btn btn-primary" onclick="createTenant()">Create</button>
    </div>
  </div>
</div>

<!-- Channel Configuration Modal -->
<div id="modal-channels" class="modal-overlay hidden">
  <div class="modal" style="min-width:680px">
    <h2>âš™ï¸ Channel Configuration â€” <span id="ch-tenant-name"></span></h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:15px">Cáº¥u hÃ¬nh kÃªnh giao tiáº¿p cho Agent. Báº­t/táº¯t vÃ  nháº­p thÃ´ng tin xÃ¡c thá»±c cho tá»«ng kÃªnh.</p>
    <div class="ch-grid" id="ch-grid"></div>
    <div class="actions" style="margin-top:20px">
      <button class="btn btn-outline" onclick="hideModal('modal-channels')">ÄÃ³ng</button>
    </div>
  </div>
</div>

<!-- Zalo QR Modal -->
<div id="modal-zalo-qr" class="modal-overlay hidden">
  <div class="modal" style="text-align:center;min-width:350px">
    <h2>ğŸ“± QuÃ©t QR Zalo</h2>
    <div id="qr-display" class="qr-container">
      <p style="color:var(--muted)">Äang táº£i mÃ£ QR...</p>
    </div>
    <div style="margin-top:12px;text-align:left">
      <label style="font-size:12px;color:var(--muted)">Hoáº·c paste cookie Zalo Web:</label>
      <textarea id="zalo-cookie-input" placeholder="Paste cookie tá»« DevTools (F12 â†’ Application â†’ Cookies â†’ chat.zalo.me)" style="font-family:monospace;font-size:11px;min-height:60px;margin-top:4px"></textarea>
    </div>
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-zalo-qr')">Huá»·</button>
      <button class="btn btn-green" onclick="saveZaloCookie()">ğŸ’¾ LÆ°u Cookie</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
const API='/api/admin';
let currentPage='dashboard';
let channelTenantId=null;
let channelTenantName='';
let authToken=localStorage.getItem('bizclaw_admin_token')||'';

// â”€â”€ Auth helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function authHeaders(extra={}){
  return {...extra,'Authorization':'Bearer '+authToken,'Content-Type':'application/json'};
}
async function authFetch(url,opts={}){
  opts.headers=authHeaders(opts.headers||{});
  const res=await fetch(url,opts);
  if(res.status===401){localStorage.removeItem('bizclaw_admin_token');authToken='';showLogin();throw new Error('Session expired');}
  return res;
}
function showLogin(){document.getElementById('login-screen').style.display='flex';}
function hideLogin(){document.getElementById('login-screen').style.display='none';}
async function doLogin(){
  const email=document.getElementById('login-email').value;
  const password=document.getElementById('login-password').value;
  const errEl=document.getElementById('login-error');
  errEl.style.display='none';
  try{
    const res=await fetch(API+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
    const r=await res.json();
    if(r.ok){authToken=r.token;localStorage.setItem('bizclaw_admin_token',authToken);hideLogin();initRouter();toast('\u2705 Login successful');}
    else{errEl.textContent=r.error||'Login failed';errEl.style.display='block';}
  }catch(e){errEl.textContent=e.message;errEl.style.display='block';}
}
function checkAuth(){
  if(!authToken){showLogin();}else{hideLogin();initRouter();}
}

// â”€â”€ Navigation (URL-based routing) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROUTE_MAP = {
  '/': 'dashboard',
  '/dashboard': 'dashboard',
  '/tenants': 'tenants',
  '/users': 'users',
  '/audit': 'audit',
  '/ollama': 'ollama',
};

function showPage(p, pushState = true){
  document.querySelectorAll('.main>div').forEach(d=>d.classList.add('hidden'));
  const page = document.getElementById('page-'+p);
  if(page) page.classList.remove('hidden');

  // Update sidebar active state
  document.querySelectorAll('.sidebar a[data-page]').forEach(a=>{
    a.classList.toggle('active', a.dataset.page === p);
  });

  // Push URL to browser history (so back/forward works)
  const url = p === 'dashboard' ? '/dashboard' : '/' + p;
  if(pushState && window.location.pathname !== url){
    history.pushState({page: p}, '', url);
  }

  currentPage=p;loadPage();
}

// Handle browser back/forward
window.addEventListener('popstate', (e) => {
  const p = e.state?.page || routeFromPath();
  showPage(p, false);
});

// Read route from current URL path
function routeFromPath(){
  const path = window.location.pathname;
  // Check for /tenants/{id} pattern
  const tenantMatch = path.match(/^\/tenants\/(.+)/);
  if(tenantMatch) return 'tenant-detail';
  return ROUTE_MAP[path] || 'dashboard';
}

// Initialize routing â€” sidebar link interception + URL-based page load
function initRouter(){
  // Intercept sidebar link clicks (prevent full page reload)
  document.querySelectorAll('.sidebar a[data-page]').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      showPage(a.dataset.page);
    });
  });

  // Also intercept inline links like "View all" that call showPage
  // These still use onclick="showPage(...)" which works fine

  // Load the page based on current URL
  const page = routeFromPath();
  showPage(page, false);
}

function loadPage(){
  if(currentPage==='dashboard')loadDashboard();
  else if(currentPage==='tenants')loadTenants();
  else if(currentPage==='tenant-detail') {} // already loaded by openTenantDetail
  else if(currentPage==='users')loadUsers();
  else if(currentPage==='audit')loadAudit();
  else if(currentPage==='ollama')loadOllama();
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg,type='success'){
  const t=document.createElement('div');t.className='toast'+(type==='error'?' error':'');
  t.textContent=msg;document.getElementById('toast-container').appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard(){
  const s=await(await authFetch(API+'/stats')).json();
  document.getElementById('stats-row').innerHTML=
    `<div class="stat"><label>Total Tenants</label><div class="val">${s.total_tenants}</div></div>`+
    `<div class="stat"><label>â–¶ Running</label><div class="val green">${s.running}</div></div>`+
    `<div class="stat"><label>â¹ Stopped</label><div class="val">${s.stopped}</div></div>`+
    `<div class="stat"><label>âš  Error</label><div class="val red">${s.error}</div></div>`+
    `<div class="stat"><label>ğŸ‘¥ Users</label><div class="val">${s.users}</div></div>`;
  const t=await(await authFetch(API+'/tenants')).json();
  document.getElementById('health-list').innerHTML=t.tenants.slice(0,5).map(t=>
    `<div class="tenant-row"><div><span class="tenant-name">${t.name}</span><div class="tenant-slug">${t.slug}</div></div><span class="badge ${t.status}">${t.status}</span></div>`).join('');
  const a=await(await authFetch(API+'/activity')).json();
  document.getElementById('activity-list').innerHTML=(a.events||[]).slice(0,8).map(e=>
    `<div class="event"><div><div class="type">${e.event_type}</div><div class="meta">${e.actor_type} (${e.actor_id.slice(0,8)}â€¦)</div></div><div class="time">${e.created_at}</div></div>`).join('')
}

// â”€â”€ Tenants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTenants(){
  const d=await(await authFetch(API+'/tenants')).json();
  const baseDomain=location.hostname.replace(/^admin\./,'');
  const proto=location.protocol;
  document.getElementById('tenants-list').innerHTML=d.tenants.map(t=>{
    return `<div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${t.name}</strong> <span class="badge ${t.status}">${t.status}</span>
          <div class="tenant-slug" style="margin-top:4px">
            <a href="${proto}//${t.slug}.${baseDomain}" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600">ğŸ”— ${t.slug}.${baseDomain}</a>
            Â· ${t.provider}/${t.model} Â· ${t.plan}
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" onclick="openTenantDetail('${t.id}','${esc(t.name)}','${esc(t.slug)}','${esc(t.provider)}','${esc(t.model)}','${t.status}','${esc(t.plan)}','${esc(t.pairing_code||'')}','${t.port||''}')" title="Tenant Detail">âš™ï¸ Detail</button>
          ${t.status!=='running'
            ?`<button class="btn btn-primary btn-sm" onclick="tenantAction('${t.id}','start')">â–¶ Start</button>`
            :`<button class="btn btn-outline btn-sm" onclick="tenantAction('${t.id}','stop')">â¹ Stop</button>`}
          <button class="btn btn-outline btn-sm" onclick="tenantAction('${t.id}','restart')">ğŸ”„</button>
          <button class="btn btn-danger btn-sm" onclick="tenantAction('${t.id}','delete')">âœ•</button>
        </div>
      </div>
      ${t.pairing_code?`<div style="margin-top:10px;font-size:12px;color:var(--muted)">Pairing: <strong style="color:var(--yellow);font-size:16px">${t.pairing_code}</strong></div>`:''}
    </div>`;
  }).join('');
}
function esc(s){return (s||"").replace(/'/g,"\\'");}


// â”€â”€ Users & Audit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers(){const d=await(await authFetch(API+'/users')).json();document.getElementById('users-list').innerHTML=(d.users||[]).map(u=>`<div class="card" style="margin-bottom:8px"><strong>${u.email}</strong> Â· ${u.role} Â· ${u.created_at}</div>`).join('')||'<p style="color:var(--muted)">No users yet</p>'}
async function loadAudit(){const d=await(await authFetch(API+'/activity')).json();document.getElementById('audit-full').innerHTML=(d.events||[]).map(e=>`<div class="event"><div><div class="type">${e.event_type}</div><div class="meta">${e.actor_type} Â· ${e.actor_id}</div></div><div class="time">${e.created_at}</div></div>`).join('')}

// â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCreateModal(){document.getElementById('modal-create').classList.remove('hidden')}
function hideModal(id){document.getElementById(id).classList.add('hidden')}

async function createTenant(){
  await authFetch(API+'/tenants',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
    name:document.getElementById('f-name').value,
    slug:document.getElementById('f-slug').value,
    provider:document.getElementById('f-provider').value,
    model:document.getElementById('f-model').value,
    plan:document.getElementById('f-plan').value
  })});
  hideModal('modal-create');toast('Tenant created!');loadPage();
}

async function tenantAction(id,action){
  if(action==='delete'&&!confirm('Delete this tenant?'))return;
  const method=action==='delete'?'DELETE':'POST';
  const url=action==='delete'?`${API}/tenants/${id}`:`${API}/tenants/${id}/${action}`;
  await authFetch(url,{method});toast(`Tenant ${action}ed`);loadPage();
}
function logout(){localStorage.removeItem('bizclaw_admin_token');authToken='';showLogin();}

// â”€â”€ Tenant Detail Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let detailTenantId = '';
let detailTenantData = {};

function openTenantDetail(id, name, slug, provider, model, status, plan, pairing, port) {
  detailTenantId = id;
  detailTenantData = {id, name, slug, provider, model, status, plan, pairing, port};
  channelTenantId = id;
  channelTenantName = name;

  // Push URL for this tenant detail
  history.pushState({page: 'tenant-detail', tenantId: id}, '', '/tenants/' + id);

  document.getElementById('detail-tenant-name').textContent = name;

  // Stats
  const baseDomain = location.hostname.replace(/^admin\./, '');
  const proto = location.protocol;
  document.getElementById('detail-stats').innerHTML =
    `<div class="stat"><label>Status</label><div class="val ${status==='running'?'green':'red'}">${status}</div></div>`+
    `<div class="stat"><label>Provider</label><div class="val">${provider}</div></div>`+
    `<div class="stat"><label>Model</label><div class="val">${model}</div></div>`+
    `<div class="stat"><label>Plan</label><div class="val">${plan}</div></div>`+
    `<div class="stat"><label>Port</label><div class="val">${port||'â€”'}</div></div>`;

  // Info card
  document.getElementById('detail-info').innerHTML = `
    <h3 style="margin-bottom:12px">ğŸ“‹ Tenant Info</h3>
    <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:14px">
      <span style="color:var(--muted)">ID:</span><code style="font-size:12px">${id}</code>
      <span style="color:var(--muted)">Slug:</span><span>${slug}</span>
      <span style="color:var(--muted)">URL:</span><a href="${proto}//${slug}.${baseDomain}" target="_blank" style="color:var(--accent)">${slug}.${baseDomain}</a>
      <span style="color:var(--muted)">Pairing:</span><strong style="color:var(--yellow)">${pairing||'N/A'}</strong>
    </div>
    <div style="margin-top:15px;display:flex;gap:8px">
      ${status!=='running'
        ?`<button class="btn btn-primary btn-sm" onclick="tenantAction('${id}','start');setTimeout(()=>showPage('tenants'),500)">â–¶ Start</button>`
        :`<button class="btn btn-outline btn-sm" onclick="tenantAction('${id}','stop');setTimeout(()=>showPage('tenants'),500)">â¹ Stop</button>`}
      <button class="btn btn-outline btn-sm" onclick="tenantAction('${id}','restart');toast('Restarting...')">ğŸ”„ Restart</button>
      <button class="btn btn-outline btn-sm" onclick="resetTenantPairing('${id}')">ğŸ”‘ Reset Pairing</button>
    </div>
  `;

  // Show detail page
  showPage('tenant-detail');
  showDetailTab('overview', document.querySelector('.detail-tab'));

  // Preload channels for channels tab
  loadDetailChannels(id);
  loadDetailModels();
}

function showDetailTab(tab, btn) {
  ['overview','settings','agents','channels','model'].forEach(t => {
    const el = document.getElementById('detail-tab-'+t);
    if(el) el.classList.toggle('hidden', t!==tab);
  });
  document.querySelectorAll('.detail-tab').forEach(b => {
    b.className = 'btn btn-outline btn-sm detail-tab';
  });
  if(btn) {
    btn.className = 'btn btn-primary btn-sm detail-tab active';
  }
  if(tab==='settings') loadTenantConfig();
  if(tab==='agents') loadTenantAgents();
}

async function loadDetailChannels(tenantId) {
  const res = await authFetch(`${API}/tenants/${tenantId}/channels`);
  const data = await res.json();
  const existing = {};
  if(data.ok && data.channels){
    data.channels.forEach(ch => {
      try { existing[ch.channel_type] = { ...ch, config: JSON.parse(ch.config_json) }; }
      catch { existing[ch.channel_type] = { ...ch, config: {} }; }
    });
  }
  loadedChannels = existing;
  renderDetailChannelCards();
}

function renderDetailChannelCards() {
  const grid = document.getElementById('detail-ch-grid');
  grid.innerHTML = CHANNEL_DEFS.map(def => {
    const saved = loadedChannels[def.type];
    const enabled = saved ? saved.enabled : false;
    const status = saved ? saved.status : 'disconnected';
    const config = saved ? saved.config : {};
    return `<div class="ch-card" id="ch-${def.type}">
      <div class="ch-header">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="ch-icon">${def.icon}</span>
          <span class="ch-name">${def.name}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge ${status}" style="font-size:10px">${status}</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-${def.type}" ${enabled?'checked':''} onchange="toggleChannel('${def.type}',this.checked)">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="ch-fields">
        ${def.fields.map(f => {
          const val = config[f.key] || '';
          if(f.type==='textarea') return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
            <textarea id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}">${val}</textarea>`;
          if(f.type==='password') return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
            <input type="password" id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}" value="${val}">`;
          return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
            <input type="text" id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}" value="${val}">`;
        }).join('')}
      </div>
      <div class="ch-actions">
        <button class="btn btn-primary btn-sm" onclick="saveChannel('${def.type}')">ğŸ’¾ LÆ°u</button>
        ${def.hasQR ? `<button class="btn btn-green btn-sm" onclick="openZaloQR()">ğŸ“± QuÃ©t QR</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function loadDetailModels() {
  const info = document.getElementById('detail-model-info');
  const list = document.getElementById('detail-models-list');
  const t = detailTenantData;
  info.innerHTML = `
    <div style="display:grid;grid-template-columns:140px 1fr;gap:8px;font-size:14px">
      <span style="color:var(--muted)">Current Provider:</span><strong>${t.provider}</strong>
      <span style="color:var(--muted)">Current Model:</span><strong style="color:var(--accent)">${t.model}</strong>
      <span style="color:var(--muted)">Ollama Host:</span><span style="font-size:12px">Shared â€” configured in platform env (OLLAMA_HOST)</span>
    </div>
  `;

  // Fetch shared Ollama models
  try {
    const r = await(await authFetch(API+'/ollama/models')).json();
    if(r.ok && r.models && r.models.length > 0) {
      list.innerHTML = r.models.map(m => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border)">
          <div>
            <strong style="color:var(--accent)">${m.name}</strong>
            <span style="color:var(--muted);font-size:12px;margin-left:8px">${m.size} Â· ${m.family||''} Â· ${m.parameter_size||''}</span>
          </div>
          <span style="font-size:12px;color:${t.model===m.name?'var(--green)':'var(--muted)'}">${t.model===m.name?'âœ… Active':'Available'}</span>
        </div>
      `).join('');
    } else {
      list.innerHTML = `<div style="padding:20px;text-align:center;color:var(--muted)">
        <p>Ollama chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t hoáº·c chÆ°a cÃ³ model nÃ o.</p>
        <p style="font-size:12px;margin-top:6px">CÃ i Ä‘áº·t: <code>curl -fsSL https://ollama.ai/install.sh | sh</code></p>
        <p style="font-size:12px;margin-top:4px">Pull model: <code>ollama pull tinyllama</code></p>
        <p style="font-size:12px;margin-top:8px;color:var(--yellow)">ğŸ’¡ Hoáº·c dÃ¹ng cloud provider (OpenAI, Anthropic, Gemini) thay cho Ollama</p>
      </div>`;
    }
  } catch(e) {
    list.innerHTML = `<div style="padding:20px;text-align:center;color:var(--red)">âŒ Cannot connect to Ollama</div>`;
  }
}

async function resetTenantPairing(id) {
  try {
    const r = await(await authFetch(`${API}/tenants/${id}/pairing`, {method:'POST'})).json();
    if(r.ok) { toast(`âœ… New pairing code: ${r.pairing_code}`); }
    else { toast(`âŒ ${r.error}`, 'error'); }
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ CHANNEL CONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CHANNEL_DEFS = [
  {
    type:'telegram', icon:'ğŸ¤–', name:'Telegram Bot', color:'#229ED9',
    fields:[
      {key:'bot_token', label:'Bot Token', placeholder:'123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11', type:'password'},
      {key:'allowed_chat_ids', label:'Allowed Chat IDs (comma-separated)', placeholder:'-100123456789, 987654321', type:'text'},
    ]
  },
  {
    type:'zalo', icon:'ğŸ’¬', name:'Zalo Personal', color:'#0068FF',
    fields:[
      {key:'cookie', label:'Zalo Cookie', placeholder:'zpw_sek=...; zpw_enk=...', type:'textarea'},
      {key:'imei', label:'IMEI (Device ID)', placeholder:'Auto-generated if empty', type:'text'},
    ],
    hasQR: true
  },
  {
    type:'discord', icon:'ğŸ®', name:'Discord Bot', color:'#5865F2',
    fields:[
      {key:'bot_token', label:'Bot Token', placeholder:'MTA0Nz...', type:'password'},
      {key:'allowed_channel_ids', label:'Allowed Channel IDs (comma-separated)', placeholder:'1234567890, 0987654321', type:'text'},
    ]
  },
  {
    type:'email', icon:'ğŸ“§', name:'Email (IMAP/SMTP)', color:'#EA4335',
    fields:[
      {key:'imap_host', label:'IMAP Host', placeholder:'imap.gmail.com', type:'text'},
      {key:'imap_port', label:'IMAP Port', placeholder:'993', type:'text'},
      {key:'smtp_host', label:'SMTP Host', placeholder:'smtp.gmail.com', type:'text'},
      {key:'smtp_port', label:'SMTP Port', placeholder:'587', type:'text'},
      {key:'email', label:'Email Address', placeholder:'bot@example.com', type:'text'},
      {key:'password', label:'App Password', placeholder:'xxxx-xxxx-xxxx-xxxx', type:'password'},
    ]
  },
  {
    type:'webhook', icon:'ğŸ”—', name:'Webhook', color:'var(--orange)',
    fields:[
      {key:'url', label:'Webhook URL', placeholder:'https://example.com/webhook', type:'text'},
      {key:'secret', label:'Webhook Secret', placeholder:'your-secret-key', type:'password'},
    ]
  },
  {
    type:'whatsapp', icon:'ğŸ“±', name:'WhatsApp Business', color:'#25D366',
    fields:[
      {key:'api_token', label:'API Token', placeholder:'EAAxxxxxx...', type:'password'},
      {key:'phone_number_id', label:'Phone Number ID', placeholder:'123456789', type:'text'},
      {key:'business_id', label:'Business ID', placeholder:'987654321', type:'text'},
    ]
  },
];

// Store loaded channel configs
let loadedChannels = {};

async function openChannels(tenantId, tenantName){
  channelTenantId = tenantId;
  channelTenantName = tenantName;
  document.getElementById('ch-tenant-name').textContent = tenantName;

  // Load existing channels from API
  const res = await authFetch(`${API}/tenants/${tenantId}/channels`);
  const data = await res.json();
  const existing = {};
  if(data.ok && data.channels){
    data.channels.forEach(ch => {
      try { existing[ch.channel_type] = { ...ch, config: JSON.parse(ch.config_json) }; }
      catch { existing[ch.channel_type] = { ...ch, config: {} }; }
    });
  }
  loadedChannels = existing;

  // Render channel cards
  renderChannelCards();
  document.getElementById('modal-channels').classList.remove('hidden');
}

function renderChannelCards(){
  const grid = document.getElementById('ch-grid');
  grid.innerHTML = CHANNEL_DEFS.map(def => {
    const saved = loadedChannels[def.type];
    const enabled = saved ? saved.enabled : false;
    const status = saved ? saved.status : 'disconnected';
    const config = saved ? saved.config : {};

    return `<div class="ch-card" id="ch-${def.type}">
      <div class="ch-header">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="ch-icon">${def.icon}</span>
          <span class="ch-name">${def.name}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge ${status}" style="font-size:10px">${status}</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-${def.type}" ${enabled?'checked':''} onchange="toggleChannel('${def.type}',this.checked)">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="ch-fields">
        ${def.fields.map(f => {
          const val = config[f.key] || '';
          if(f.type==='textarea'){
            return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
              <textarea id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}">${val}</textarea>`;
          }
          if(f.type==='password'){
            return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
              <input type="password" id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}" value="${val}">`;
          }
          return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
            <input type="text" id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}" value="${val}">`;
        }).join('')}
      </div>
      <div class="ch-actions">
        <button class="btn btn-primary btn-sm" onclick="saveChannel('${def.type}')">ğŸ’¾ LÆ°u</button>
        ${def.hasQR ? `<button class="btn btn-green btn-sm" onclick="openZaloQR()">ğŸ“± QuÃ©t QR</button>` : ''}
        ${saved ? `<button class="btn btn-danger btn-sm" onclick="removeChannel('${def.type}','${saved.id}')">âœ• XoÃ¡</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function saveChannel(type){
  const def = CHANNEL_DEFS.find(d=>d.type===type);
  if(!def) return;

  const config = {};
  def.fields.forEach(f => {
    const el = document.getElementById(`ch-${type}-${f.key}`);
    if(el) config[f.key] = el.value;
  });

  const enabled = document.getElementById(`toggle-${type}`).checked;

  const res = await authFetch(`${API}/tenants/${channelTenantId}/channels`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ channel_type: type, enabled, config })
  });
  const data = await res.json();
  if(data.ok){
    toast(`${def.name} â€” ÄÃ£ lÆ°u cáº¥u hÃ¬nh!`);
    // Reload
    const r2 = await authFetch(`${API}/tenants/${channelTenantId}/channels`);
    const d2 = await r2.json();
    loadedChannels = {};
    if(d2.ok && d2.channels){
      d2.channels.forEach(ch => {
        try { loadedChannels[ch.channel_type] = { ...ch, config: JSON.parse(ch.config_json) }; }
        catch { loadedChannels[ch.channel_type] = { ...ch, config: {} }; }
      });
    }
    renderChannelCards();
  } else {
    toast(data.error || 'Lá»—i lÆ°u cáº¥u hÃ¬nh', 'error');
  }
}

async function toggleChannel(type, enabled){
  // Auto-save toggle state
  const def = CHANNEL_DEFS.find(d=>d.type===type);
  if(!def) return;

  const config = {};
  def.fields.forEach(f => {
    const el = document.getElementById(`ch-${type}-${f.key}`);
    if(el) config[f.key] = el.value;
  });

  await authFetch(`${API}/tenants/${channelTenantId}/channels`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ channel_type: type, enabled, config })
  });
  toast(`${def.name} â€” ${enabled?'ÄÃ£ báº­t':'ÄÃ£ táº¯t'}`);
}

async function removeChannel(type, channelId){
  if(!confirm('XoÃ¡ cáº¥u hÃ¬nh kÃªnh nÃ y?')) return;
  await authFetch(`${API}/tenants/${channelTenantId}/channels/${channelId}`, {method:'DELETE'});
  delete loadedChannels[type];
  renderChannelCards();
  toast('ÄÃ£ xoÃ¡ kÃªnh');
}

// â”€â”€ Zalo QR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openZaloQR(){
  document.getElementById('modal-zalo-qr').classList.remove('hidden');
  document.getElementById('qr-display').innerHTML = '<p style="color:var(--muted)">â³ Äang táº¡o mÃ£ QR...</p>';
  document.getElementById('zalo-cookie-input').value = '';

  try {
    const res = await authFetch(`${API}/tenants/${channelTenantId}/channels/zalo/qr`, {method:'POST'});
    const data = await res.json();
    if(data.ok && data.qr_code){
      document.getElementById('qr-display').innerHTML = `
        <img src="${data.qr_code}" alt="Zalo QR Code" style="max-width:200px;border:2px solid var(--accent);border-radius:8px">
        <p style="margin-top:8px;font-size:12px;color:var(--muted)">${data.message || 'Má»Ÿ Zalo â†’ QuÃ©t mÃ£ QR'}</p>
      `;
    } else {
      document.getElementById('qr-display').innerHTML = `
        <p style="color:var(--yellow)">âš ï¸ ${data.error || 'KhÃ´ng láº¥y Ä‘Æ°á»£c QR'}</p>
        <p style="font-size:12px;color:var(--muted);margin-top:6px">${data.fallback || 'Vui lÃ²ng paste cookie bÃªn dÆ°á»›i'}</p>
      `;
    }
  } catch(e) {
    document.getElementById('qr-display').innerHTML = `
      <p style="color:var(--yellow)">âš ï¸ Lá»—i káº¿t ná»‘i Ä‘áº¿n server</p>
      <p style="font-size:12px;color:var(--muted);margin-top:6px">Vui lÃ²ng paste cookie Zalo Web bÃªn dÆ°á»›i</p>
    `;
  }
}

async function saveZaloCookie(){
  const cookie = document.getElementById('zalo-cookie-input').value.trim();
  if(!cookie){
    toast('Vui lÃ²ng nháº­p cookie Zalo', 'error');
    return;
  }

  // Save cookie to Zalo channel config
  const el = document.getElementById('ch-zalo-cookie');
  if(el) el.value = cookie;

  // Auto-save
  await saveChannel('zalo');
  hideModal('modal-zalo-qr');
  toast('âœ… Cookie Zalo Ä‘Ã£ Ä‘Æ°á»£c lÆ°u!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ OLLAMA / BRAIN ENGINE MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadOllama(){
  await ollamaHealth();
  await ollamaListModels();
}

async function ollamaHealth(){
  try{
    const r=await(await authFetch(API+'/ollama/health')).json();
    const el=document.getElementById('ollama-status');
    const card=document.getElementById('ollama-health-card');
    document.getElementById('ollama-url').textContent=r.url||'â€”';
    if(r.ok){
      el.textContent='â— Running';el.style.color='var(--green)';
    }else{
      el.innerHTML=`<span style="color:var(--red)">âœ• ${r.status||'Not Running'}</span>`;
      if(r.install_guide){
        el.innerHTML+=`<div style="font-size:11px;color:var(--muted);margin-top:6px">Install: <code>${r.install_guide}</code></div>`;
      }
    }
  }catch(e){
    document.getElementById('ollama-status').innerHTML='<span style="color:var(--red)">âœ• Error</span>';
  }
}

async function ollamaListModels(){
  try{
    const r=await(await authFetch(API+'/ollama/models')).json();
    const tbody=document.getElementById('ollama-models');
    const empty=document.getElementById('ollama-empty');
    if(!r.ok||!r.models||r.models.length===0){
      tbody.innerHTML='';empty.style.display='block';
      document.getElementById('ollama-count').textContent='0';
      return;
    }
    empty.style.display='none';
    document.getElementById('ollama-count').textContent=r.models.length;
    tbody.innerHTML=r.models.map(m=>`<tr>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)"><strong style="color:var(--accent)">${m.name}</strong></td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)">${m.size}</td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)">${m.family||'â€”'}</td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)">${m.parameter_size||'â€”'}</td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)">${m.quantization||'â€”'}</td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border);text-align:right">
        <button class="btn btn-danger btn-sm" onclick="ollamaDeleteModel('${m.name}')">âœ• Delete</button>
      </td>
    </tr>`).join('');
  }catch(e){
    document.getElementById('ollama-models').innerHTML='';
    document.getElementById('ollama-empty').style.display='block';
  }
}

async function pullModel(){
  const custom=document.getElementById('pull-model-custom').value.trim();
  const select=document.getElementById('pull-model-name').value;
  const model=custom||select;
  if(!model){toast('Chá»n hoáº·c nháº­p tÃªn model','error');return;}

  const btn=document.getElementById('pull-btn');
  const status=document.getElementById('pull-status');
  btn.disabled=true;btn.textContent='â³ Downloading...';
  status.style.display='block';status.textContent=`Downloading ${model}... This may take several minutes.`;

  try{
    const r=await(await authFetch(API+'/ollama/pull',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model})})).json();
    if(r.ok){
      toast(`âœ… ${r.message||'Model pulled!'}`);
      status.textContent=`âœ… ${model} pulled successfully!`;status.style.color='var(--green)';
      await ollamaListModels();
    }else{
      toast(`âŒ ${r.error||'Pull failed'}`,'error');
      status.textContent=`âŒ ${r.error||'Failed'}`;status.style.color='var(--red)';
    }
  }catch(e){
    toast('âŒ '+e.message,'error');
    status.textContent='âŒ '+e.message;status.style.color='var(--red)';
  }finally{
    btn.disabled=false;btn.textContent='ğŸ“¥ Pull';
    setTimeout(()=>{status.style.display='none';status.style.color='var(--muted)';},5000);
  }
}

async function ollamaDeleteModel(name){
  if(!confirm(`XoÃ¡ model "${name}"?`))return;
  try{
    const r=await(await authFetch(API+'/ollama/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:name})})).json();
    if(r.ok){toast(`âœ… ${r.message}`);await ollamaListModels();}
    else{toast(`âŒ ${r.error||'Delete failed'}`,'error');}
  }catch(e){toast('âŒ '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ TENANT CONFIG (SETTINGS TAB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadTenantConfig() {
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/configs`)).json();
    if(r.ok && r.configs) {
      const c = r.configs;
      const setVal = (id, key) => { const el=document.getElementById(id); if(el) el.value=c[key]||''; };
      setVal('cfg-provider','default_provider');
      setVal('cfg-model','default_model');
      setVal('cfg-api-key','api_key');
      setVal('cfg-api-url','api_base_url');
      setVal('cfg-identity-name','identity.name');
      setVal('cfg-identity-persona','identity.persona');
      setVal('cfg-identity-prompt','identity.system_prompt');
      // Set select dropdown
      const sel = document.getElementById('cfg-provider');
      if(sel && c.default_provider) {
        for(let i=0;i<sel.options.length;i++) {
          if(sel.options[i].value===c.default_provider) { sel.selectedIndex=i; break; }
        }
      }
    }
  } catch(e) { console.error('Load config error:', e); }
}

async function saveTenantConfig() {
  const configs = {
    default_provider: document.getElementById('cfg-provider').value,
    default_model: document.getElementById('cfg-model').value,
    api_key: document.getElementById('cfg-api-key').value,
    api_base_url: document.getElementById('cfg-api-url').value,
    'identity.name': document.getElementById('cfg-identity-name').value,
    'identity.persona': document.getElementById('cfg-identity-persona').value,
    'identity.system_prompt': document.getElementById('cfg-identity-prompt').value,
  };
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/configs`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({configs})
    })).json();
    if(r.ok) {
      toast(`âœ… Settings saved (${r.saved} keys)`);
      document.getElementById('cfg-save-status').textContent = 'âœ… Saved!';
      setTimeout(() => document.getElementById('cfg-save-status').textContent = '', 3000);
    } else {
      toast(r.error||'Save failed', 'error');
    }
  } catch(e) { toast('âŒ '+e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ TENANT AGENTS (AGENTS TAB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showAddAgentForm() {
  document.getElementById('add-agent-form').classList.remove('hidden');
  document.getElementById('ag-name').value = '';
  document.getElementById('ag-role').value = 'assistant';
  document.getElementById('ag-desc').value = '';
  document.getElementById('ag-prompt').value = '';
}

async function loadTenantAgents() {
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/agents`)).json();
    const list = document.getElementById('agents-list');
    if(r.ok && r.agents && r.agents.length > 0) {
      list.innerHTML = r.agents.map(a => `
        <div class="card" style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong style="color:var(--accent)">${a.name}</strong>
              <span class="badge running" style="margin-left:8px">${a.role}</span>
              <span style="font-size:12px;color:var(--muted);margin-left:8px">${a.provider}/${a.model}</span>
            </div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-danger btn-sm" onclick="deleteTenantAgent('${esc(a.name)}')">âœ•</button>
            </div>
          </div>
          ${a.description ? `<div style="font-size:12px;color:var(--muted);margin-top:6px">${a.description}</div>` : ''}
          ${a.system_prompt ? `<div style="font-size:11px;color:var(--muted);margin-top:4px;font-family:monospace;max-height:40px;overflow:hidden;text-overflow:ellipsis">ğŸ“ ${a.system_prompt.slice(0,120)}${a.system_prompt.length>120?'...':''}</div>` : ''}
        </div>
      `).join('');
    } else {
      list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted)"><p>ğŸ‘» ChÆ°a cÃ³ agent nÃ o.</p><p style="font-size:12px;margin-top:4px">Nháº¥n "+ ThÃªm Agent" Ä‘á»ƒ táº¡o agent má»›i.</p></div>';
    }
  } catch(e) { console.error('Load agents error:', e); }
}

async function createTenantAgent() {
  const body = {
    name: document.getElementById('ag-name').value.trim(),
    role: document.getElementById('ag-role').value.trim() || 'assistant',
    description: document.getElementById('ag-desc').value.trim(),
    provider: document.getElementById('ag-provider').value,
    model: document.getElementById('ag-model').value.trim(),
    system_prompt: document.getElementById('ag-prompt').value.trim(),
  };
  if(!body.name) { toast('Nháº­p tÃªn agent', 'error'); return; }
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/agents`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    })).json();
    if(r.ok) {
      toast(`âœ… Agent "${body.name}" created!`);
      document.getElementById('add-agent-form').classList.add('hidden');
      loadTenantAgents();
    } else { toast(r.error||'Create failed', 'error'); }
  } catch(e) { toast('âŒ '+e.message, 'error'); }
}

async function deleteTenantAgent(name) {
  if(!confirm(`XoÃ¡ agent "${name}"?`)) return;
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/agents/${encodeURIComponent(name)}`, {method:'DELETE'})).json();
    if(r.ok) { toast(`âœ… Agent "${name}" deleted`); loadTenantAgents(); }
    else { toast(r.error||'Delete failed', 'error'); }
  } catch(e) { toast('âŒ '+e.message, 'error'); }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkAuth();
</script>
</body>
</html>
