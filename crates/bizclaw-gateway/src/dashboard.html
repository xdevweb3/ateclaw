<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BizClaw â€” Agent Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#08090d;--bg2:#0d1017;--surface:#12151e;--surface2:#1a1e2e;--border:#1e2433;--border-hover:#2a3048;
  --text:#e8ecf4;--text2:#7c8599;--accent:#6366f1;--accent2:#818cf8;--accent-glow:rgba(99,102,241,.12);
  --green:#34d399;--red:#ef4444;--orange:#fb923c;--blue:#60a5fa;--cyan:#22d3ee;--pink:#f472b6;
  --grad1:linear-gradient(135deg,#6366f1,#8b5cf6);
  --radius:10px;--font:'Inter',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.6}
a{color:var(--accent2);text-decoration:none}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Layout */
.app{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh}
.main{padding:28px 36px;overflow-y:auto;height:100vh}

/* Sidebar */
.logo{padding:20px;display:flex;align-items:center;gap:10px;font-size:17px;font-weight:700;border-bottom:1px solid var(--border)}
.logo .icon{font-size:22px}
.logo .text{background:var(--grad1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav{flex:1;padding:8px}
.nav a{display:flex;align-items:center;gap:10px;padding:9px 14px;border-radius:8px;color:var(--text2);font-size:13px;font-weight:500;transition:all .15s;cursor:pointer}
.nav a:hover{background:var(--surface2);color:var(--text)}
.nav a.active{background:var(--accent-glow);color:var(--accent2)}
.nav-sep{height:1px;background:var(--border);margin:8px 12px}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text2)}

/* Header */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-header h1{font-size:22px;font-weight:700}
.page-header .sub{font-size:13px;color:var(--text2)}

/* Cards & Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color .2s}
.card:hover{border-color:var(--border-hover)}
.card-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;font-weight:600}
.card-value{font-size:26px;font-weight:700}
.card-sub{font-size:11px;color:var(--text2);margin-top:3px}

/* Colors */
.green{color:var(--green)}.red{color:var(--red)}.orange{color:var(--orange)}.blue{color:var(--blue)}.accent{color:var(--accent2)}.cyan{color:var(--cyan)}

/* Forms */
.form-section{margin-bottom:28px}
.form-section h2{font-size:15px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.form-row{display:grid;grid-template-columns:160px 1fr;align-items:center;gap:12px;padding:10px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
.form-label{font-size:12px;color:var(--text2);font-weight:500}
.form-row input,.form-row select,.form-row textarea{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;font-family:var(--font);outline:none;transition:border-color .2s}
.form-row input:focus,.form-row select:focus,.form-row textarea:focus{border-color:var(--accent)}
.form-row textarea{min-height:60px;resize:vertical;font-family:var(--mono);font-size:12px}

/* Buttons */
.btn{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;font-family:var(--font)}
.btn-primary{background:var(--grad1);color:#fff}
.btn-primary:hover{box-shadow:0 4px 16px rgba(99,102,241,.35);transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent2)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-green{background:#059669;color:#fff}.btn-green:hover{background:#047857}
.btn-red{background:var(--red);color:#fff}.btn-red:hover{opacity:.9}

/* Badges */
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.badge-green{background:rgba(52,211,153,.12);color:var(--green)}
.badge-blue{background:rgba(96,165,250,.12);color:var(--blue)}
.badge-orange{background:rgba(251,146,60,.12);color:var(--orange)}
.badge-red{background:rgba(239,68,68,.12);color:var(--red)}
.badge-purple{background:rgba(99,102,241,.12);color:var(--accent2)}

/* Tables */
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;padding:8px 12px;border-bottom:1px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px}
tr:hover td{background:rgba(255,255,255,.02)}

/* Chat */
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 120px)}
.chat-messages{flex:1;overflow-y:auto;padding:12px 0;display:flex;flex-direction:column;gap:10px}
.msg{max-width:72%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.55;animation:fadeIn .2s}
.msg-user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.msg-bot{align-self:flex-start;background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px;white-space:pre-wrap;font-family:var(--font)}
.msg-system{align-self:center;font-size:11px;color:var(--text2);font-style:italic}
.chat-input-wrap{display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--border)}
.chat-input-wrap input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 16px;color:var(--text);font-size:13px;outline:none}
.chat-input-wrap input:focus{border-color:var(--accent)}
.chat-input-wrap button{background:var(--grad1);color:#fff;border:none;border-radius:8px;padding:11px 20px;font-size:13px;cursor:pointer;font-weight:600}
.typing{color:var(--text2);font-size:12px;padding:4px 0}

/* Channel cards */
.ch-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.ch-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color .2s}
.ch-card:hover{border-color:var(--border-hover)}
.ch-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.ch-name{font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px}
.ch-fields{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.ch-fields label{font-size:11px;color:var(--text2);font-weight:500}
.ch-fields input,.ch-fields textarea{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-size:12px;outline:none;font-family:var(--mono)}
.ch-fields input:focus,.ch-fields textarea:focus{border-color:var(--accent)}
.ch-fields textarea{min-height:50px;resize:vertical}
.ch-actions{display:flex;gap:6px;flex-wrap:wrap}
.toggle{position:relative;width:36px;height:20px;display:inline-block}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:.2s}
.toggle .slider::before{content:'';position:absolute;width:16px;height:16px;left:2px;bottom:2px;background:#fff;border-radius:50%;transition:.2s}
.toggle input:checked + .slider{background:var(--accent)}
.toggle input:checked + .slider::before{transform:translateX(16px)}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-size:13px;z-index:999;animation:slideUp .3s;box-shadow:0 8px 32px rgba(0,0,0,.4)}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.pulse{animation:pulse 1.5s infinite}

/* Responsive */
@media(max-width:768px){.app{grid-template-columns:1fr}.sidebar{display:none}.main{padding:16px}.form-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<!-- Pairing Gate -->
<div id="pairing-gate" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:300;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:380px;text-align:center">
    <div style="font-size:32px;margin-bottom:12px">ğŸ”</div>
    <h2 style="color:var(--accent);margin-bottom:8px">BizClaw Agent</h2>
    <p style="color:var(--text2);font-size:13px;margin-bottom:24px">Nháº­p mÃ£ Pairing Code Ä‘á»ƒ truy cáº­p Dashboard</p>
    <div id="pairing-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
    <input id="pairing-input" type="text" placeholder="Pairing Code (6 digits)" maxlength="10" style="width:100%;padding:12px 16px;margin-bottom:14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;text-align:center;letter-spacing:4px;font-family:var(--mono)" onkeydown="if(event.key==='Enter')doPairing()">
    <button style="width:100%;padding:12px;background:var(--grad1);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer" onclick="doPairing()">ğŸ”“ XÃ¡c nháº­n</button>
  </div>
</div>

<div id="app-container" class="app">
  <aside class="sidebar">
    <div class="logo"><span class="icon">âš¡</span><span class="text">BizClaw</span></div>
    <nav class="nav">
      <a href="/dashboard" onclick="navigateTo(event,'dashboard')" class="active" id="nav-dashboard">ğŸ“Š <span data-i18n="nav.dashboard">Báº£ng Ä‘iá»u khiá»ƒn</span></a>
      <a href="/chat" onclick="navigateTo(event,'chat')" id="nav-chat">ğŸ’¬ <span data-i18n="nav.webchat">TrÃ² chuyá»‡n</span></a>
      <div class="nav-sep"></div>
      <a href="/settings" onclick="navigateTo(event,'settings')" id="nav-settings">âš™ï¸ <span data-i18n="nav.settings">CÃ i Ä‘áº·t</span></a>
      <a href="/providers" onclick="navigateTo(event,'providers')" id="nav-providers">ğŸ”Œ <span data-i18n="nav.providers">NhÃ  cung cáº¥p</span></a>
      <a href="/channels" onclick="navigateTo(event,'channels')" id="nav-channels">ğŸ“± <span data-i18n="nav.channels">KÃªnh liÃªn láº¡c</span></a>
      <a href="/tools" onclick="navigateTo(event,'tools')" id="nav-tools">ğŸ› ï¸ <span data-i18n="nav.tools">CÃ´ng cá»¥</span></a>
      <a href="/mcp" onclick="navigateTo(event,'mcp')" id="nav-mcp">ğŸ”— <span data-i18n="nav.mcp">MÃ¡y chá»§ MCP</span></a>
      <a href="/agents" onclick="navigateTo(event,'agents')" id="nav-agents">ğŸ¤– <span data-i18n="nav.agents">Äa tÃ¡c tá»­</span></a>
      <a href="/groups" onclick="navigateTo(event,'groups')" id="nav-groups">ğŸ‘¥ <span data-i18n="nav.groups">NhÃ³m Agent</span></a>
      <a href="/knowledge" onclick="navigateTo(event,'knowledge')" id="nav-knowledge">ğŸ“š <span data-i18n="nav.knowledge">Kho tri thá»©c</span></a>
      <div class="nav-sep"></div>
      <a href="/brain" onclick="navigateTo(event,'brain')" id="nav-brain">ğŸ§  <span data-i18n="nav.brain">Brain Engine</span></a>
      <a href="/configfile" onclick="navigateTo(event,'configfile')" id="nav-configfile">ğŸ“„ <span data-i18n="nav.config">Tá»‡p cáº¥u hÃ¬nh</span></a>
    </nav>
    <div class="sidebar-footer">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
        <button onclick="setLang('vi')" id="btn-vi" style="padding:2px 8px;font-size:11px;border-radius:4px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer">VI</button>
        <button onclick="setLang('en')" id="btn-en" style="padding:2px 8px;font-size:11px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer">EN</button>
      </div>
      <div id="ws-status">â¬œ <span data-i18n="status.disconnected">ÄÃ£ ngáº¯t káº¿t ná»‘i</span></div>
      <div style="margin-top:4px" id="agent-name">BizClaw Agent</div>
    </div>
  </aside>
  <main class="main">
    <!-- â•â•â• ONBOARDING WIZARD (first visit) â•â•â• -->
    <div id="onboard-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center">
      <div class="card" style="max-width:560px;width:90%;padding:32px;animation:fadeIn 0.3s">
        <div id="onboard-step-1">
          <h2>ğŸ‰ ChÃ o má»«ng Ä‘áº¿n vá»›i BizClaw!</h2>
          <p style="color:var(--text-dim);margin:8px 0 20px" data-i18n="onboard.welcome_sub">HÃ£y Ä‘á»ƒ AI táº¡o má»™t trá»£ lÃ½ phÃ¹ há»£p riÃªng cho báº¡n. Chá»‰ máº¥t 30 giÃ¢y.</p>
          <div class="form-row"><span class="form-label" data-i18n="onboard.your_name">TÃªn báº¡n</span><input id="onboard-name" placeholder="VD: HoÃ i"></div>
          <div class="form-row"><span class="form-label" data-i18n="onboard.about_you">Báº¡n lÃ  ai, lÃ m gÃ¬?</span><textarea id="onboard-about" rows="3" placeholder="VD: TÃ´i lÃ  founder startup cÃ´ng nghá»‡, cáº§n AI há»— trá»£ quáº£n lÃ½ dá»± Ã¡n vÃ  code"></textarea></div>
          <div class="form-row"><span class="form-label" data-i18n="onboard.agent_vibe">Phong cÃ¡ch Agent</span>
            <select id="onboard-vibe">
              <option value="helpful, professional, concise">ğŸ¤ ChuyÃªn nghiá»‡p & Ngáº¯n gá»n</option>
              <option value="friendly, casual, uses emoji">ğŸ˜Š ThÃ¢n thiá»‡n & Thoáº£i mÃ¡i</option>
              <option value="creative, inspiring, out-of-the-box">ğŸ¨ SÃ¡ng táº¡o & Truyá»n cáº£m há»©ng</option>
              <option value="strict, precise, technical expert">ğŸ”¬ NghiÃªm tÃºc & Ká»¹ thuáº­t cao</option>
              <option value="humorous, witty, smart">ğŸ˜„ DÃ­ dá»m & ThÃ´ng minh</option>
            </select>
          </div>
          <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="onboardNext()">Tiáº¿p theo â†’</button>
          <button class="btn" style="width:100%;margin-top:8px;background:transparent;color:var(--text-dim)" onclick="skipOnboard()">Bá» qua</button>
        </div>
        <div id="onboard-step-2" style="display:none">
          <h2>âš¡ Chá»n AI Provider</h2>
          <p style="color:var(--text-dim);margin:8px 0 20px" data-i18n="onboard.provider_sub">Chá»n nguá»“n AI. KhÃ´ng cáº§n API key? DÃ¹ng Ollama hoáº·c Brain Engine.</p>
          <div class="form-row"><span class="form-label">Provider</span>
            <select id="onboard-provider" onchange="onboardProviderChange()">
              <option value="ollama">ğŸ–¥ï¸ Ollama (Local, miá»…n phÃ­)</option>
              <option value="openai">â˜ï¸ OpenAI (GPT-4o)</option>
              <option value="gemini">â˜ï¸ Google Gemini</option>
              <option value="anthropic">â˜ï¸ Anthropic Claude</option>
              <option value="deepseek">â˜ï¸ DeepSeek</option>
            </select>
          </div>
          <div id="onboard-cloud-fields" style="display:none">
            <div class="form-row"><span class="form-label">Model</span><input id="onboard-model" placeholder="gpt-4o-mini"></div>
            <div class="form-row"><span class="form-label">API Key</span><input id="onboard-apikey" type="password" placeholder="sk-..."></div>
            <div class="form-row"><span class="form-label">API Base URL <span style="color:var(--text-dim)">(optional)</span></span><input id="onboard-baseurl" placeholder="https://api.openai.com/v1 (custom proxy)"></div>
          </div>
          <div id="onboard-ollama-info" class="card" style="background:var(--bg);margin-top:12px;padding:12px">
            <p>ğŸ“¥ <strong>Ollama</strong>: Cháº¡y AI 100% local, khÃ´ng cáº§n internet.</p>
            <code style="font-size:12px">curl -fsSL https://ollama.ai/install.sh | sh && ollama pull qwen3:0.6b</code>
          </div>
          <div style="display:flex;gap:8px;margin-top:16px">
            <button class="btn" style="flex:1" onclick="document.getElementById('onboard-step-2').style.display='none';document.getElementById('onboard-step-1').style.display=''">â† Quay láº¡i</button>
            <button class="btn btn-primary" style="flex:2" onclick="finishOnboard()">ğŸš€ HoÃ n táº¥t & Báº¯t Ä‘áº§u</button>
          </div>
        </div>
        <div id="onboard-step-done" style="display:none;text-align:center">
          <div style="font-size:64px;margin:20px 0">ğŸ‰</div>
          <h2 data-i18n="onboard.done_title">Agent Ä‘Ã£ sáºµn sÃ ng!</h2>
          <p style="color:var(--text-dim)" data-i18n="onboard.done_sub">AI Ä‘ang táº¡o tÃ­nh cÃ¡ch riÃªng cho agent cá»§a báº¡n...</p>
          <div id="onboard-progress" style="margin:20px 0;color:var(--accent)">â³ Äang xá»­ lÃ½...</div>
        </div>
      </div>
    </div>

    <!-- â•â•â• DASHBOARD (LobsterBoard-inspired) â•â•â• -->
    <div id="page-dashboard">
      <div class="page-header"><div><h1 data-i18n="dash.title">Báº£ng Ä‘iá»u khiá»ƒn</h1><div class="sub" data-i18n="dash.subtitle">Trung tÃ¢m quáº£n lÃ½ Agent Gateway</div></div></div>
      <!-- Widget Row 1: Quick Stats -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px">
        <div class="card" style="text-align:center">
          <div class="card-label">â° <span data-i18n="dash.clock">Äá»“ng há»“</span></div>
          <div class="card-value accent" id="w-clock" style="font-size:22px;font-family:var(--mono)">--:--</div>
          <div class="card-sub" id="w-date">â€”</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.uptime">Uptime</div>
          <div class="card-value green" id="s-uptime" style="font-size:22px">â€”</div>
          <div class="card-sub" data-i18n="dash.status">Online</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.provider">Provider</div>
          <div class="card-value blue" id="s-provider" style="font-size:18px">â€”</div>
          <div class="card-sub" id="s-model" style="color:var(--cyan)">â€”</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.version">Version</div>
          <div class="card-value accent" id="s-version" style="font-size:18px">â€”</div>
          <div class="card-sub" id="s-platform" style="font-size:10px">â€”</div>
        </div>
      </div>
      <!-- Widget Row 2: System & Channels -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
        <!-- System Info Widget -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div class="card-label" style="margin:0">ğŸ–¥ï¸ <span data-i18n="dash.system">Há»‡ thá»‘ng</span></div>
            <span class="badge badge-green" id="s-status">â— <span data-i18n="dash.online">Trá»±c tuyáº¿n</span></span>
          </div>
          <div id="dash-system" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
            <div><span style="color:var(--text2)" data-i18n="sys.os">Há»‡ Ä‘iá»u hÃ nh:</span> <span id="sys-os">â€”</span></div>
            <div><span style="color:var(--text2)" data-i18n="sys.arch">Kiáº¿n trÃºc:</span> <span id="sys-arch">â€”</span></div>
            <div><span style="color:var(--text2)">SIMD:</span> <span id="brain-simd" style="color:var(--accent2)">â€”</span></div>
            <div><span style="color:var(--text2)" data-i18n="sys.memory">Bá»™ nhá»›:</span> <span id="sys-mem">â€”</span></div>
          </div>
        </div>
        <!-- Quick Actions Widget -->
        <div class="card">
          <div class="card-label" style="margin-bottom:10px">âš¡ <span data-i18n="dash.quickactions">Thao tÃ¡c nhanh</span></div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'chat')">ğŸ’¬ <span data-i18n="nav.webchat">TrÃ² chuyá»‡n</span></button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'settings')">âš™ï¸ <span data-i18n="nav.settings">CÃ i Ä‘áº·t</span></button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'channels')">ğŸ“± <span data-i18n="nav.channels">KÃªnh</span></button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'brain')">ğŸ§  Brain</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'configfile')">ğŸ“„ Config</button>
          </div>
        </div>
      </div>
      <!-- Widget Row 3: Channel Table -->
      <div class="card">
        <div class="card-label" style="margin-bottom:10px">ğŸ“¡ <span data-i18n="dash.channels">Active Channels</span></div>
        <table><thead><tr><th data-i18n="th.channel">KÃªnh</th><th data-i18n="th.type">Loáº¡i</th><th data-i18n="th.status">Tráº¡ng thÃ¡i</th><th data-i18n="th.configured">Config</th></tr></thead><tbody id="dash-channels"></tbody></table>
      </div>
    </div>

    <!-- â•â•â• WEBCHAT â•â•â• -->
    <div id="page-chat" style="display:none">
      <div class="page-header"><h1>ğŸ’¬ <span data-i18n="chat.title">TrÃ² chuyá»‡n</span></h1></div>
      <div class="chat-wrap">
        <div class="chat-messages" id="chat-messages">
          <div class="msg msg-system" data-i18n="chat.welcome">ÄÃ£ káº¿t ná»‘i BizClaw. Nháº­p tin nháº¯n Ä‘á»ƒ báº¯t Ä‘áº§u trÃ² chuyá»‡n.</div>
        </div>
        <div class="typing" id="chat-typing" style="display:none"><span data-i18n="chat.thinking">BizClaw Ä‘ang suy nghÄ©</span><span class="pulse">...</span></div>
        <div class="chat-input-wrap">
          <input type="text" id="chat-input" placeholder="Nháº­p tin nháº¯n..." data-i18n-placeholder="chat.placeholder" onkeydown="if(event.key==='Enter')sendChat()">
          <button onclick="sendChat()" data-i18n="chat.send">Gá»­i â†‘</button>
        </div>
      </div>
    </div>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <div id="page-settings" style="display:none">
      <div class="page-header"><div><h1>âš™ï¸ <span data-i18n="settings.title">CÃ i Ä‘áº·t Agent</span></h1><div class="sub" data-i18n="settings.subtitle">Cáº¥u hÃ¬nh AI agent â€” nhÃ  cung cáº¥p, mÃ´ hÃ¬nh, danh tÃ­nh, báº£o máº­t</div></div>
        <button class="btn btn-primary" onclick="saveSettings()" data-i18n="settings.save">ğŸ’¾ LÆ°u cÃ i Ä‘áº·t</button>
      </div>
      <div class="form-section">
        <h2>ğŸ¤– <span data-i18n="set.provider_section">NhÃ  cung cáº¥p AI</span></h2>
        <div class="form-row"><span class="form-label" data-i18n="set.provider">NhÃ  cung cáº¥p</span><select id="set-provider" onchange="onProviderChange()">
          <option value="openai">OpenAI</option><option value="anthropic">Anthropic</option>
          <option value="gemini">Gemini</option><option value="deepseek">DeepSeek</option>
          <option value="groq">Groq</option><option value="ollama">Ollama (ná»™i bá»™)</option>
          <option value="llamacpp">llama.cpp</option><option value="brain">Brain Engine (ngoáº¡i tuyáº¿n)</option>
        </select></div>
        <!-- Cloud provider fields -->
        <div id="provider-cloud-fields">
          <div class="form-row"><span class="form-label" data-i18n="set.model">MÃ´ hÃ¬nh</span><input id="set-model" placeholder="gpt-4o-mini"></div>
          <div class="form-row"><span class="form-label" data-i18n="set.apikey">KhÃ³a API</span><input id="set-apikey" type="password" placeholder="sk-..."></div>
          <div class="form-row"><span class="form-label" data-i18n="set.baseurl">API Base URL</span><input id="set-baseurl" placeholder="Custom API proxy URL (Ä‘á»ƒ trá»‘ng = máº·c Ä‘á»‹nh)"></div>
        </div>
        <!-- Ollama fields -->
        <div id="provider-ollama-fields" style="display:none">
          <div class="form-row"><span class="form-label" data-i18n="set.model">MÃ´ hÃ¬nh</span>
            <div style="display:flex;gap:8px;flex:1">
              <select id="set-ollama-model" style="flex:1"><option value="" data-i18n="set.loading_models">Äang táº£i mÃ´ hÃ¬nh...</option></select>
              <button class="btn btn-outline btn-sm" onclick="loadOllamaModels()" title="Refresh models">ğŸ”„</button>
            </div>
          </div>
          <div id="ollama-status-row" class="form-row" style="background:var(--accent-glow);border-color:var(--accent)"><span class="form-label" style="color:var(--accent2)">ğŸ’¡ Status</span><span id="ollama-status-msg" style="font-size:12px;color:var(--text2)">Checking Ollama...</span></div>
        </div>
        <!-- Brain Engine fields -->
        <div id="provider-brain-fields" style="display:none">
          <div class="form-row"><span class="form-label" data-i18n="set.model_path">ÄÆ°á»ng dáº«n mÃ´ hÃ¬nh</span>
            <div style="display:flex;gap:8px;flex:1">
              <input id="set-brain-path" placeholder="~/.bizclaw/models/tinyllama.gguf" style="flex:1">
              <button class="btn btn-outline btn-sm" onclick="scanBrainModels()" title="QuÃ©t tÃ¬m mÃ´ hÃ¬nh GGUF">ğŸ“‚ <span data-i18n="set.scan">QuÃ©t</span></button>
            </div>
          </div>
          <div id="brain-models-found" style="display:none;margin:-8px 0 8px 0">
            <div style="font-size:11px;color:var(--text2);margin-bottom:4px">Found GGUF models â€” click to select:</div>
            <div id="brain-models-list" style="display:flex;flex-wrap:wrap;gap:4px"></div>
          </div>
          <div class="form-row"><span class="form-label" data-i18n="set.threads">Luá»“ng xá»­ lÃ½</span><input id="set-brain-threads" type="number" min="1" max="32" value="4" placeholder="4"></div>
          <div class="form-row" style="background:var(--accent-glow);border-color:var(--accent)"><span class="form-label" style="color:var(--accent2)">ğŸ§  Brain</span><span style="font-size:12px;color:var(--text2)">GGUF models run 100% offline. Download: <code style="color:var(--cyan)">bizclaw brain download tinyllama-1.1b</code></span></div>
        </div>
        <!-- llama.cpp fields -->
        <div id="provider-llamacpp-fields" style="display:none">
          <div class="form-row"><span class="form-label">Server URL</span><input id="set-llamacpp-url" placeholder="http://localhost:8080"></div>
          <div class="form-row"><span class="form-label">Model</span><input id="set-llamacpp-model" placeholder="(auto-detected)"></div>
        </div>
        <div class="form-row"><span class="form-label" data-i18n="set.temperature">Nhiá»‡t Ä‘á»™</span><input id="set-temp" type="number" step="0.1" min="0" max="2" value="0.7"></div>
      </div>
      <div class="form-section">
        <h2>ğŸ­ <span data-i18n="set.identity">Danh tÃ­nh</span></h2>
        <div class="form-row"><span class="form-label" data-i18n="set.agent_name">TÃªn Agent</span><input id="set-name" placeholder="BizClaw"></div>
        <div class="form-row"><span class="form-label" data-i18n="set.persona">Vai trÃ²</span><input id="set-persona" placeholder="Trá»£ lÃ½ AI thÃ´ng minh"></div>
        <div class="form-row"><span class="form-label" data-i18n="set.sysprompt">Lá»i nháº¯c há»‡ thá»‘ng</span><textarea id="set-sysprompt" placeholder="Báº¡n lÃ  BizClaw, trá»£ lÃ½ AI nhanh vÃ  Ä‘Ã¡ng tin cáº­y."></textarea></div>
      </div>
      <div class="form-section">
        <h2>ğŸ’¾ <span data-i18n="set.memory">Bá»™ nhá»›</span></h2>
        <div class="form-row"><span class="form-label" data-i18n="set.backend">Backend</span><select id="set-mem-backend"><option value="sqlite">SQLite</option><option value="postgres">PostgreSQL</option><option value="none">KhÃ´ng (NoOp)</option></select></div>
        <div class="form-row"><span class="form-label" data-i18n="set.autosave">Tá»± Ä‘á»™ng lÆ°u</span><select id="set-mem-autosave"><option value="true">CÃ³</option><option value="false">KhÃ´ng</option></select></div>
      </div>
      <div class="form-section">
        <h2>ğŸ”’ <span data-i18n="set.security">Báº£o máº­t / Quyá»n tá»± chá»§</span></h2>
        <div class="form-row"><span class="form-label" data-i18n="set.autonomy">Má»©c tá»± chá»§</span><select id="set-auto-level"><option value="readonly" data-i18n="set.readonly">Chá»‰ Ä‘á»c</option><option value="supervised" data-i18n="set.supervised">GiÃ¡m sÃ¡t</option><option value="full" data-i18n="set.full">ToÃ n quyá»n</option></select></div>
        <div class="form-row"><span class="form-label" data-i18n="set.workspace_only">Chá»‰ Workspace</span><select id="set-auto-workspace"><option value="true">CÃ³</option><option value="false">KhÃ´ng</option></select></div>
      </div>
    </div>

    <!-- â•â•â• PROVIDERS â•â•â• -->
    <div id="page-providers" style="display:none">
      <div class="page-header"><div><h1>ğŸ”Œ <span data-i18n="providers.title">NhÃ  cung cáº¥p</span></h1><div class="sub" data-i18n="providers.subtitle">Cáº¥u hÃ¬nh nhÃ  cung cáº¥p AI â€” chá»n provider máº·c Ä‘á»‹nh, API key, model</div></div></div>
      <div class="stats">
        <div class="card"><div class="card-label" data-i18n="providers.active_label">Provider Ä‘ang dÃ¹ng</div><div class="card-value green" id="prov-active-name" style="font-size:18px">â€”</div></div>
        <div class="card"><div class="card-label" data-i18n="set.model">MÃ´ hÃ¬nh</div><div class="card-value blue" id="prov-active-model" style="font-size:16px">â€”</div></div>
        <div class="card"><div class="card-label" data-i18n="providers.total_label">Tá»•ng providers</div><div class="card-value accent" id="prov-total">0</div></div>
      </div>
      <div class="ch-grid" id="providers-grid"></div>
    </div>

    <!-- â•â•â• CHANNELS â•â•â• -->
    <div id="page-channels" style="display:none">
      <div class="page-header"><div><h1>ğŸ“± <span data-i18n="channels.title">Cáº¥u hÃ¬nh kÃªnh liÃªn láº¡c</span></h1><div class="sub" data-i18n="channels.subtitle">Káº¿t ná»‘i agent vá»›i cÃ¡c ná»n táº£ng nháº¯n tin</div></div></div>
      <div class="ch-grid" id="channels-grid"></div>
      <!-- Zalo QR Modal -->
      <div id="zalo-qr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:420px;width:90%;text-align:center">
          <h2 style="margin-bottom:12px">ğŸ“± Zalo QR Login</h2>
          <div id="zalo-qr-content" style="margin:16px 0;min-height:100px"><div class="pulse" style="color:var(--text2)">Äang táº¡o mÃ£ QR...</div></div>
          <div id="zalo-qr-instructions" style="font-size:12px;color:var(--text2);text-align:left;margin:12px 0"></div>
          <div id="zalo-qr-imei" style="font-size:11px;color:var(--text2);margin:8px 0"></div>
          <button class="btn btn-outline" onclick="closeZaloQR()" style="margin-top:12px">ÄÃ³ng</button>
        </div>
      </div>
    </div>

    <!-- â•â•â• TOOLS â•â•â• -->
    <div id="page-tools" style="display:none">
      <div class="page-header"><div><h1>ğŸ› ï¸ <span data-i18n="tools.title">CÃ´ng cá»¥</span></h1><div class="sub" data-i18n="tools.subtitle">15 cÃ´ng cá»¥ tÃ­ch há»£p + cÃ´ng cá»¥ MCP bÃªn ngoÃ i</div></div></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px">
        <div class="card"><div class="card-label">ğŸ–¥ï¸ Shell</div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.shell_desc">Thá»±c thi lá»‡nh há»‡ thá»‘ng (sandbox)</div></div>
        <div class="card"><div class="card-label">ğŸ“„ <span data-i18n="tool.file">Tá»‡p tin</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.file_desc">Äá»c/ghi/liá»‡t kÃª tá»‡p tin</div></div>
        <div class="card"><div class="card-label">âœï¸ <span data-i18n="tool.editfile">Sá»­a tá»‡p</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.editfile_desc">Thay tháº¿ chÃ­nh xÃ¡c ná»™i dung trong tá»‡p</div></div>
        <div class="card"><div class="card-label">ğŸ” Glob</div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.glob_desc">TÃ¬m tá»‡p theo máº«u (*.rs, **/*.toml)</div></div>
        <div class="card"><div class="card-label">ğŸ” Grep</div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.grep_desc">TÃ¬m ná»™i dung trong tá»‡p báº±ng regex</div></div>
        <div class="card"><div class="card-label">ğŸŒ <span data-i18n="tool.websearch">TÃ¬m kiáº¿m Web</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub">DuckDuckGo (khÃ´ng cáº§n API key)</div></div>
        <div class="card"><div class="card-label">ğŸ“¡ <span data-i18n="tool.httpreq">HTTP Request</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.httpreq_desc">Gá»i API bÃªn ngoÃ i (GET/POST/PUT/DELETE)</div></div>
        <div class="card"><div class="card-label">âš™ï¸ <span data-i18n="tool.configmgr">Quáº£n lÃ½ cáº¥u hÃ¬nh</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.configmgr_desc">Äá»c/ghi config.toml lÃºc runtime</div></div>
        <div class="card"><div class="card-label">ğŸ§  <span data-i18n="tool.memsearch">TÃ¬m trÃ­ nhá»›</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.memsearch_desc">TÃ¬m há»™i thoáº¡i cÅ© báº±ng FTS5</div></div>
        <div class="card"><div class="card-label">ğŸš€ <span data-i18n="tool.execcode">Cháº¡y mÃ£</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.execcode_desc">Cháº¡y code Python, JS, Go, Rust, C...</div></div>
        <div class="card"><div class="card-label">ğŸ“‹ <span data-i18n="tool.plan">Káº¿ hoáº¡ch</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.plan_desc">PhÃ¢n rÃ£ tÃ¡c vá»¥ vá»›i phá»¥ thuá»™c vÃ  Ä‘á»™ phá»©c táº¡p</div></div>
        <div class="card"><div class="card-label">ğŸ“Š <span data-i18n="tool.sessionctx">Ngá»¯ cáº£nh phiÃªn</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.sessionctx_desc">ThÃ´ng tin phiÃªn: provider, token, tools</div></div>
        <div class="card"><div class="card-label">ğŸ“… <span data-i18n="tool.calendar">Lá»‹ch</span></div><div class="card-value orange" style="font-size:16px">â— <span data-i18n="tool.available">Sáºµn sÃ ng</span></div><div class="card-sub" data-i18n="tool.calendar_desc">TÃ­ch há»£p Google Calendar</div></div>
        <div class="card"><div class="card-label">ğŸ“– <span data-i18n="tool.docreader">Äá»c tÃ i liá»‡u</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.docreader_desc">TrÃ­ch xuáº¥t PDF, DOCX, Excel, CSV</div></div>
        <div class="card"><div class="card-label">ğŸ’¬ <span data-i18n="tool.summarizer">TÃ³m táº¯t nhÃ³m</span></div><div class="card-value green" style="font-size:16px">â— <span data-i18n="tool.active">Hoáº¡t Ä‘á»™ng</span></div><div class="card-sub" data-i18n="tool.summarizer_desc">TÃ³m táº¯t tin nháº¯n nhÃ³m Zalo/Telegram</div></div>
      </div>
    </div>

    <!-- â•â•â• MCP SERVERS â•â•â• -->
    <div id="page-mcp" style="display:none">
      <div class="page-header"><div><h1>ğŸ”— <span data-i18n="mcp.title">MÃ¡y chá»§ MCP</span></h1><div class="sub" data-i18n="mcp.subtitle">Model Context Protocol â€” má»Ÿ rá»™ng agent vá»›i cÃ´ng cá»¥ bÃªn ngoÃ i</div></div>
        <button class="btn btn-primary" onclick="showMcpForm()">+ <span data-i18n="mcp.add">ThÃªm mÃ¡y chá»§</span></button>
      </div>
      <div class="stats" id="mcp-stats">
        <div class="card"><div class="card-label" data-i18n="mcp.total">Tá»•ng mÃ¡y chá»§</div><div class="card-value accent" id="mcp-total">0</div></div>
        <div class="card"><div class="card-label" data-i18n="mcp.active">Äang hoáº¡t Ä‘á»™ng</div><div class="card-value green" id="mcp-active">0</div></div>
        <div class="card"><div class="card-label" data-i18n="mcp.protocol">Giao thá»©c</div><div class="card-value blue">MCP v2024-11-05</div></div>
      </div>
      <div id="mcp-list" class="ch-grid" style="margin-top:16px"></div>
      <!-- Add MCP Server Form (hidden) -->
      <div id="mcp-add-form" class="card" style="display:none;margin-top:16px">
        <h3>â• <span data-i18n="mcp.add_title">ThÃªm mÃ¡y chá»§ MCP</span></h3>
        <label data-i18n="form.name">TÃªn</label>
        <input id="mcp-name" placeholder="vd: filesystem, github, memory">
        <label data-i18n="form.command">Lá»‡nh</label>
        <input id="mcp-command" placeholder="vd: npx, uvx, node">
        <label data-i18n="form.args">Tham sá»‘ (phÃ¢n cÃ¡ch báº±ng dáº¥u pháº©y)</label>
        <input id="mcp-args" placeholder="vd: -y,@modelcontextprotocol/server-filesystem,/home">
        <label data-i18n="form.env">Biáº¿n mÃ´i trÆ°á»ng (KEY=VALUE, má»—i dÃ²ng má»™t cáº·p)</label>
        <textarea id="mcp-env" rows="3" placeholder="GITHUB_TOKEN=ghp_xxx&#10;API_KEY=sk-xxx"></textarea>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="addMcpServer()">ğŸ’¾ <span data-i18n="form.save">LÆ°u</span></button>
          <button class="btn btn-outline" onclick="hideMcpForm()" data-i18n="form.cancel">Há»§y</button>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <h3>ğŸ“– <span data-i18n="mcp.popular">MCP phá»• biáº¿n</span></h3>
        <table><thead><tr><th data-i18n="form.name">TÃªn</th><th data-i18n="form.command">Lá»‡nh</th><th data-i18n="form.description">MÃ´ táº£</th></tr></thead><tbody>
          <tr><td><strong>Filesystem</strong></td><td><code>npx -y @modelcontextprotocol/server-filesystem /path</code></td><td>Read/write files</td></tr>
          <tr><td><strong>GitHub</strong></td><td><code>npx -y @modelcontextprotocol/server-github</code></td><td>Issues, PRs, repos</td></tr>
          <tr><td><strong>Memory</strong></td><td><code>npx -y @modelcontextprotocol/server-memory</code></td><td>Persistent memory</td></tr>
          <tr><td><strong>Brave Search</strong></td><td><code>npx -y @modelcontextprotocol/server-brave-search</code></td><td>Web search</td></tr>
          <tr><td><strong>Puppeteer</strong></td><td><code>npx -y @modelcontextprotocol/server-puppeteer</code></td><td>Browser automation</td></tr>
          <tr><td><strong>Postgres</strong></td><td><code>npx -y @modelcontextprotocol/server-postgres "postgresql://..."</code></td><td>Database queries</td></tr>
        </tbody></table>
        <div style="margin-top:8px;font-size:12px;color:var(--text2)">More at <a href="https://github.com/modelcontextprotocol/servers" target="_blank" style="color:var(--accent)">github.com/modelcontextprotocol/servers</a></div>
      </div>
    </div>

    <!-- â•â•â• BRAIN ENGINE + WORKSPACE + HEALTH â•â•â• -->
    <div id="page-brain" style="display:none">
      <div class="page-header"><div><h1>ğŸ§  <span data-i18n="brain.title">Brain Engine</span></h1><div class="sub" data-i18n="brain.ws_sub">Brain workspace, personality files, and system health check</div></div>
        <button class="btn btn-primary" onclick="runHealthCheck()">ğŸ©º <span data-i18n="brain.health_btn">Health Check</span></button>
      </div>
      <div class="stats">
        <div class="card"><div class="card-label" data-i18n="brain.engine">Äá»™ng cÆ¡</div><div class="card-value green">GGUF v3</div></div>
        <div class="card"><div class="card-label">SIMD</div><div class="card-value accent" id="brain-simd">â€”</div></div>
        <div class="card"><div class="card-label" data-i18n="brain.quant">LÆ°á»£ng tá»­ hÃ³a</div><div class="card-value blue">Q4_0 / Q8_0 / F16</div></div>
        <div class="card"><div class="card-label" data-i18n="brain.files_count">Brain Files</div><div class="card-value cyan" id="brain-files-count">0</div></div>
      </div>

      <!-- Health Check Results -->
      <div id="health-results" class="card" style="display:none;margin-top:16px">
        <h3>ğŸ©º <span data-i18n="brain.health_title">System Health Check</span></h3>
        <div id="health-summary" style="margin:8px 0"></div>
        <table><thead><tr><th data-i18n="brain.check_name">Check</th><th data-i18n="brain.check_status">Status</th><th data-i18n="brain.check_detail">Detail</th></tr></thead>
        <tbody id="health-checks-body"></tbody></table>
      </div>

      <!-- Brain Files Editor -->
      <div class="form-section" style="margin-top:16px"><h2>ğŸ“ <span data-i18n="brain.ws_title">Brain Workspace</span></h2>
        <div class="sub" id="brain-base-dir" style="margin-bottom:12px"></div>
        <div style="display:flex;gap:8px;margin-bottom:16px">
          <input id="brain-new-filename" placeholder="CUSTOM.md" style="flex:1">
          <button class="btn btn-primary" onclick="createBrainFile()">+ <span data-i18n="brain.new_file">New File</span></button>
        </div>
        <div id="brain-files-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:8px"></div>
      </div>

      <!-- File Editor (hidden until a file is clicked) -->
      <div id="brain-editor" class="card" style="display:none;margin-top:16px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 id="brain-editor-title">ğŸ“„ SOUL.md</h3>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" onclick="saveBrainFile()">ğŸ’¾ <span data-i18n="brain.save">Save</span></button>
            <button class="btn" style="background:#dc3545" onclick="deleteBrainFile()">ğŸ—‘ï¸</button>
            <button class="btn" onclick="closeBrainEditor()">âœ•</button>
          </div>
        </div>
        <textarea id="brain-editor-content" style="width:100%;min-height:300px;font-family:monospace;font-size:13px;margin-top:8px;background:var(--bg-card);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:12px;resize:vertical"></textarea>
      </div>

      <!-- Models Table -->
      <div class="form-section"><h2 data-i18n="brain.models">MÃ´ hÃ¬nh cÃ³ sáºµn</h2>
        <div class="card"><table><thead><tr><th data-i18n="set.model">MÃ´ hÃ¬nh</th><th data-i18n="brain.size">KÃ­ch thÆ°á»›c</th><th data-i18n="brain.download">Táº£i vá»</th></tr></thead><tbody>
          <tr><td><strong>TinyLlama 1.1B</strong></td><td>~638 MB</td><td><code>bizclaw brain download tinyllama-1.1b</code></td></tr>
          <tr><td><strong>Phi-2</strong></td><td>~1.6 GB</td><td><code>bizclaw brain download phi-2</code></td></tr>
          <tr><td><strong>Llama 3.2 1B</strong></td><td>~750 MB</td><td><code>bizclaw brain download llama-3.2-1b</code></td></tr>
          <tr><td><strong>Qwen 3 0.6B</strong></td><td>~400 MB</td><td><code>bizclaw brain download qwen3-0.6b</code></td></tr>
        </tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• MULTI-AGENT â•â•â• -->
    <div id="page-agents" style="display:none">
      <div class="page-header"><div><h1>ğŸ¤– <span data-i18n="agents.title">Äa tÃ¡c tá»­ AI</span></h1><div class="sub" data-i18n="agents.subtitle">Táº¡o vÃ  quáº£n lÃ½ nhiá»u agent AI vá»›i vai trÃ² khÃ¡c nhau</div></div>
        <button class="btn btn-primary" onclick="showCreateAgentForm()">+ <span data-i18n="agents.create">Táº¡o Agent</span></button>
      </div>
      <div class="stats">
        <div class="card"><div class="card-label" data-i18n="agents.total">Tá»•ng Agent</div><div class="card-value accent" id="agents-total">0</div></div>
        <div class="card"><div class="card-label" data-i18n="agents.default">Agent máº·c Ä‘á»‹nh</div><div class="card-value green" id="agents-default">â€”</div></div>
        <div class="card"><div class="card-label" data-i18n="agents.messages">Tin nháº¯n</div><div class="card-value blue" id="agents-messages">0</div></div>
      </div>
      <!-- Create Agent Form -->
      <div id="agent-create-form" class="card" style="display:none;margin-top:16px">
        <h3>â• <span data-i18n="agents.create_new">Táº¡o Agent má»›i</span></h3>
        <div class="form-row"><span class="form-label" data-i18n="form.name">TÃªn</span><input id="new-agent-name" placeholder="researcher"></div>
        <div class="form-row"><span class="form-label" data-i18n="form.role">Vai trÃ²</span><select id="new-agent-role">
          <option value="assistant">Trá»£ lÃ½</option><option value="researcher">NhÃ  nghiÃªn cá»©u</option>
          <option value="coder">Láº­p trÃ¬nh viÃªn</option><option value="writer">NhÃ  vÄƒn</option>
          <option value="analyst">PhÃ¢n tÃ­ch viÃªn</option><option value="translator">PhiÃªn dá»‹ch</option>
        </select></div>
        <div class="form-row"><span class="form-label" data-i18n="form.description">MÃ´ táº£</span><input id="new-agent-desc" placeholder="Agent nghiÃªn cá»©u thÃ´ng minh"></div>
        <div class="form-row"><span class="form-label" data-i18n="set.sysprompt">Lá»i nháº¯c há»‡ thá»‘ng</span><textarea id="new-agent-prompt" placeholder="Báº¡n lÃ  agent nghiÃªn cá»©u chuyÃªn sÃ¢u..."></textarea></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="createAgent()">ğŸ¤– <span data-i18n="agents.create">Táº¡o</span></button>
          <button class="btn btn-outline" onclick="document.getElementById('agent-create-form').style.display='none'" data-i18n="form.cancel">Há»§y</button>
        </div>
      </div>
      <div id="agents-list" class="ch-grid" style="margin-top:16px"></div>
      <!-- Broadcast -->
      <div class="card" style="margin-top:16px">
        <h3>ğŸ“¢ <span data-i18n="agents.broadcast">PhÃ¡t tin nháº¯n</span></h3>
        <div class="form-row"><span class="form-label" data-i18n="agents.msg">Tin nháº¯n</span><input id="broadcast-msg" placeholder="Gá»­i tá»›i táº¥t cáº£ agent..."></div>
        <button class="btn btn-primary btn-sm" onclick="broadcastMessage()">ğŸ“¢ <span data-i18n="agents.send_all">Gá»­i táº¥t cáº£</span></button>
        <div id="broadcast-results" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- â•â•â• AGENT GROUP CHAT â•â•â• -->
    <div id="page-groups" style="display:none">
      <div class="page-header"><div><h1>ğŸ‘¥ <span data-i18n="groups.title">NhÃ³m Agent</span></h1><div class="sub" data-i18n="groups.subtitle">Táº¡o nhÃ³m cÃ¡c Agent AI cÃ¹ng trao Ä‘á»•i vÃ  phá»‘i há»£p â€” nhÆ° OpenClaw</div></div>
        <button class="btn btn-primary" onclick="showCreateGroupForm()">+ <span data-i18n="groups.create">Táº¡o nhÃ³m</span></button>
      </div>
      <div class="stats">
        <div class="card"><div class="card-label" data-i18n="groups.total">Tá»•ng nhÃ³m</div><div class="card-value accent" id="groups-total">0</div></div>
        <div class="card"><div class="card-label" data-i18n="groups.agents_count">Agent trong nhÃ³m</div><div class="card-value blue" id="groups-agents">0</div></div>
        <div class="card"><div class="card-label" data-i18n="groups.conversations">Cuá»™c há»™i thoáº¡i</div><div class="card-value green" id="groups-convos">0</div></div>
      </div>
      <!-- Create Group Form -->
      <div id="group-create-form" class="card" style="display:none;margin-top:16px">
        <h3>â• <span data-i18n="groups.create_new">Táº¡o nhÃ³m má»›i</span></h3>
        <div class="form-row"><span class="form-label" data-i18n="form.name">TÃªn</span><input id="new-group-name" placeholder="vd: Dev Team, Marketing Team"></div>
        <div class="form-row"><span class="form-label" data-i18n="groups.topic">Chá»§ Ä‘á»</span><input id="new-group-topic" placeholder="vd: PhÃ¢n tÃ­ch vÃ  phÃ¡t triá»ƒn mÃ£ nguá»“n"></div>
        <div style="margin:12px 0">
          <div class="form-label" style="margin-bottom:8px" data-i18n="groups.select_agents">Chá»n Agent tham gia:</div>
          <div id="group-agent-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          <div style="font-size:11px;color:var(--text2);margin-top:6px" data-i18n="groups.agent_hint">ChÆ°a cÃ³ agent? VÃ o trang Äa tÃ¡c tá»­ Ä‘á»ƒ táº¡o trÆ°á»›c.</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="createGroup()">ğŸ‘¥ <span data-i18n="groups.create">Táº¡o nhÃ³m</span></button>
          <button class="btn btn-outline" onclick="document.getElementById('group-create-form').style.display='none'" data-i18n="form.cancel">Há»§y</button>
        </div>
      </div>
      <!-- Groups List -->
      <div id="groups-list" class="ch-grid" style="margin-top:16px"></div>
      <!-- Group Conversation Modal -->
      <div id="group-chat-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(4px)">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:700px;width:95%;max-height:85vh;display:flex;flex-direction:column">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h2 id="group-chat-title" style="font-size:16px">ğŸ‘¥ Group Chat</h2>
            <button class="btn btn-outline btn-sm" onclick="closeGroupChat()">âœ• ÄÃ³ng</button>
          </div>
          <div style="font-size:11px;color:var(--text2);margin-bottom:8px" id="group-chat-members"></div>
          <div id="group-chat-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;min-height:300px;max-height:55vh;padding:8px 0"></div>
          <div style="display:flex;gap:8px;padding-top:10px;border-top:1px solid var(--border)">
            <input id="group-chat-input" placeholder="Nháº­p tin nháº¯n gá»­i Ä‘áº¿n nhÃ³m..." style="flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;outline:none" onkeydown="if(event.key==='Enter')sendGroupMessage()">
            <button class="btn btn-primary" onclick="sendGroupMessage()">Gá»­i â†‘</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• KNOWLEDGE BASE â•â•â• -->
    <div id="page-knowledge" style="display:none">
      <div class="page-header"><div><h1>ğŸ“š <span data-i18n="kb.title">Kho tri thá»©c</span></h1><div class="sub" data-i18n="kb.subtitle">RAG cÃ¡ nhÃ¢n â€” thÃªm tÃ i liá»‡u Ä‘á»ƒ AI tráº£ lá»i chÃ­nh xÃ¡c hÆ¡n</div></div>
        <button class="btn btn-primary" onclick="showAddDocForm()">+ <span data-i18n="kb.add_doc">ThÃªm tÃ i liá»‡u</span></button>
      </div>
      <div class="stats">
        <div class="card"><div class="card-label" data-i18n="kb.documents">TÃ i liá»‡u</div><div class="card-value accent" id="kb-docs">0</div></div>
        <div class="card"><div class="card-label" data-i18n="kb.chunks">Äoáº¡n vÄƒn</div><div class="card-value blue" id="kb-chunks">0</div></div>
        <div class="card"><div class="card-label" data-i18n="kb.search_engine">CÃ´ng cá»¥ tÃ¬m kiáº¿m</div><div class="card-value green">FTS5</div></div>
      </div>
      <!-- Search -->
      <div class="card" style="margin-top:16px">
        <h3>ğŸ” <span data-i18n="kb.search">TÃ¬m kiáº¿m tri thá»©c</span></h3>
        <div style="display:flex;gap:8px"><input id="kb-search-input" placeholder="TÃ¬m trong tÃ i liá»‡u..." style="flex:1" onkeydown="if(event.key==='Enter')searchKnowledge()"><button class="btn btn-primary btn-sm" onclick="searchKnowledge()" data-i18n="kb.search_btn">TÃ¬m kiáº¿m</button></div>
        <div id="kb-search-results" style="margin-top:12px"></div>
      </div>
      <!-- Add Document Form -->
      <div id="kb-add-form" class="card" style="display:none;margin-top:16px">
        <h3>â• <span data-i18n="kb.add_title">ThÃªm tÃ i liá»‡u</span></h3>
        <div class="form-row"><span class="form-label" data-i18n="form.name">TÃªn</span><input id="kb-doc-name" placeholder="ghi_chu_cuoc_hop.txt"></div>
        <div class="form-row"><span class="form-label" data-i18n="kb.source">Nguá»“n</span><input id="kb-doc-source" placeholder="thá»§ cÃ´ng" value="dashboard"></div>
        <div class="form-row"><span class="form-label" data-i18n="kb.content">Ná»™i dung</span><textarea id="kb-doc-content" rows="6" placeholder="DÃ¡n ná»™i dung tÃ i liá»‡u vÃ o Ä‘Ã¢y..."></textarea></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="addDocument()">ğŸ’¾ <span data-i18n="form.save">LÆ°u</span></button>
          <button class="btn btn-outline" onclick="document.getElementById('kb-add-form').style.display='none'" data-i18n="form.cancel">Há»§y</button>
        </div>
      </div>
      <!-- Document List -->
      <div class="card" style="margin-top:16px">
        <h3>ğŸ“„ <span data-i18n="kb.doc_list">Danh sÃ¡ch tÃ i liá»‡u</span></h3>
        <div id="kb-doc-list"></div>
      </div>
    </div>

    <!-- â•â•â• CONFIG FILE â•â•â• -->
    <div id="page-configfile" style="display:none">
      <div class="page-header"><div><h1>ğŸ“„ config.toml</h1><div class="sub" id="config-path">â€”</div></div></div>
      <div class="card"><pre id="config-toml-content" style="font-family:var(--mono);font-size:12px;line-height:1.7;color:var(--accent2);white-space:pre-wrap;max-height:70vh;overflow-y:auto;padding:4px">Loading...</pre></div>
    </div>
  </main>
</div>

<script>
const API = '';
let ws = null, configData = {};
let pairingCode = sessionStorage.getItem('bizclaw_pairing')||'';

// â•â•â• AUTH â•â•â•
function authHeaders(extra={}){
  return {...extra,'X-Pairing-Code':pairingCode,'Content-Type':'application/json'};
}
async function authFetch(url,opts={}){
  if(!opts.headers) opts.headers={};
  opts.headers['X-Pairing-Code']=pairingCode;
  const res=await fetch(url,opts);
  if(res.status===401){sessionStorage.removeItem('bizclaw_pairing');pairingCode='';showPairingGate();throw new Error('Invalid pairing code');}
  return res;
}
function showPairingGate(){
  document.getElementById('pairing-gate').style.display='flex';
  document.getElementById('app-container').style.display='none';
}
function hidePairingGate(){
  document.getElementById('pairing-gate').style.display='none';
  document.getElementById('app-container').style.display='grid';
}
async function doPairing(){
  const code=document.getElementById('pairing-input').value.trim();
  const errEl=document.getElementById('pairing-error');
  errEl.style.display='none';
  if(!code){errEl.textContent='Vui l\xf2ng nh\u1eadp m\xe3 pairing';errEl.style.display='block';return;}
  try{
    const res=await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
    const r=await res.json();
    if(r.ok){pairingCode=code;sessionStorage.setItem('bizclaw_pairing',code);hidePairingGate();initApp();}
    else{errEl.textContent=r.error||'Sai m\xe3 pairing';errEl.style.display='block';}
  }catch(e){errEl.textContent=e.message;errEl.style.display='block';}
}
async function checkPairing(){
  // First check if pairing is required at all
  try{
    const res=await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:''})});
    const r=await res.json();
    if(r.ok){hidePairingGate();initApp();return;} // no pairing required
  }catch(e){}
  if(pairingCode){
    try{const r=await(await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:pairingCode})})).json();
      if(r.ok){hidePairingGate();initApp();return;}
    }catch(e){}
  }
  showPairingGate();
}

// â•â•â• NAVIGATION (Path Router â€” History API) â•â•â•
function navigateTo(event, name) {
  if (event) event.preventDefault();
  showPage(name, true);
}

function showPage(name, pushState) {
  // Update URL path using History API
  const targetPath = '/' + (name === 'dashboard' ? '' : name);
  if (pushState !== false && location.pathname !== targetPath && !(name === 'dashboard' && location.pathname === '/')) {
    history.pushState({ page: name }, '', targetPath);
  }
  document.querySelectorAll('[id^=page-]').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  const nav = document.getElementById('nav-' + name);
  if (page) page.style.display = '';
  if (nav) nav.classList.add('active');
  if (name === 'chat') document.getElementById('chat-input').focus();
  if (name === 'settings') loadSettingsForm();
  if (name === 'channels') renderChannelCards();
  if (name === 'configfile') loadConfigToml();
  if (name === 'mcp') loadMcpServers();
  if (name === 'agents') loadAgents();
  if (name === 'knowledge') loadKnowledgeDocs();
  if (name === 'brain') loadBrainFiles();
  if (name === 'groups') renderGroups();
}

// Handle browser back/forward
window.addEventListener('popstate', (ev) => {
  const name = getPageFromPath();
  showPage(name, false);
});

// Get page name from current URL pathname
function getPageFromPath() {
  const path = location.pathname.replace(/^\//, '').replace(/\/$/, '');
  // Map valid page names
  const validPages = ['dashboard','chat','settings','providers','channels','tools','brain','configfile','mcp','agents','knowledge','groups'];
  if (!path || path === '' || !validPages.includes(path)) return 'dashboard';
  return path;
}

// Route from current path on load
function routeFromPath() {
  const name = getPageFromPath();
  showPage(name, false);
}

// â•â•â• DASHBOARD (widget-based) â•â•â•
function updateClock() {
  const now = new Date();
  const el = document.getElementById('w-clock');
  const dt = document.getElementById('w-date');
  if(el) el.textContent = now.toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(dt) dt.textContent = now.toLocaleDateString(currentLang==='vi'?'vi-VN':'en-US',{weekday:'short',month:'short',day:'numeric'});
}
setInterval(updateClock, 1000);

async function loadDashboard() {
  updateClock();
  try {
    const info = await (await authFetch(API + '/api/v1/info')).json();
    document.getElementById('s-version').textContent = 'v' + (info.version||'?');
    document.getElementById('s-provider').textContent = info.default_provider || 'â€”';
    document.getElementById('s-model').textContent = info.default_model || 'â€”';
    document.getElementById('s-uptime').textContent = fmtUptime(info.uptime_secs);
    document.getElementById('s-platform').textContent = info.platform || 'â€”';
    document.getElementById('agent-name').textContent = (info.name || 'BizClaw') + ' Agent';
    const arch = info.platform || '';
    document.getElementById('brain-simd').textContent = arch.includes('aarch64') ? 'NEON' : arch.includes('x86') ? 'AVX2/SSE2' : 'Auto';
    // Parse system info
    const parts = arch.split('-');
    const sysOs = document.getElementById('sys-os');
    const sysArch = document.getElementById('sys-arch');
    if(sysOs) sysOs.textContent = parts.length >= 2 ? parts.slice(1).join('-') : arch;
    if(sysArch) sysArch.textContent = parts[0] || 'â€”';
  } catch(e) {}
  try {
    const ch = await (await authFetch(API + '/api/v1/channels')).json();
    document.getElementById('dash-channels').innerHTML = ch.channels.map(c => `<tr>
      <td><strong>${c.name}</strong></td><td>${c.type}</td>
      <td><span class="badge badge-${c.status==='active'?'green':c.status==='disabled'?'orange':'blue'}">${c.status}</span></td>
      <td>${c.configured?'âœ…':'â€”'}</td>
    </tr>`).join('');
  } catch(e) {}
}

const PROVIDERS_META = [
  {name:'openai',label:'OpenAI',icon:'ğŸ¤–',type:'cloud',models:['gpt-4o','gpt-4o-mini','gpt-3.5-turbo','o1-mini','o3-mini'],fields:[
    {key:'api_key',label:'API Key',type:'password',placeholder:'sk-...'},
    {key:'model',label:'Model',type:'text',placeholder:'gpt-4o-mini'},
    {key:'base_url',label:'Base URL (optional)',type:'text',placeholder:'https://api.openai.com/v1'},
  ]},
  {name:'anthropic',label:'Anthropic',icon:'ğŸ§ ',type:'cloud',models:['claude-sonnet-4','claude-3.5-sonnet','claude-3-haiku'],fields:[
    {key:'api_key',label:'API Key',type:'password',placeholder:'sk-ant-...'},
    {key:'model',label:'Model',type:'text',placeholder:'claude-sonnet-4-20250514'},
    {key:'base_url',label:'Base URL (optional)',type:'text',placeholder:''},
  ]},
  {name:'gemini',label:'Google Gemini',icon:'ğŸ’',type:'cloud',models:['gemini-2.5-pro','gemini-2.5-flash','gemini-2.0-flash'],fields:[
    {key:'api_key',label:'API Key',type:'password',placeholder:'AIza...'},
    {key:'model',label:'Model',type:'text',placeholder:'gemini-2.5-flash'},
    {key:'base_url',label:'Base URL (optional)',type:'text',placeholder:''},
  ]},
  {name:'deepseek',label:'DeepSeek',icon:'ğŸŒŠ',type:'cloud',models:['deepseek-chat','deepseek-reasoner'],fields:[
    {key:'api_key',label:'API Key',type:'password',placeholder:'sk-...'},
    {key:'model',label:'Model',type:'text',placeholder:'deepseek-chat'},
    {key:'base_url',label:'Base URL (optional)',type:'text',placeholder:''},
  ]},
  {name:'groq',label:'Groq',icon:'âš¡',type:'cloud',models:['llama-3.3-70b','mixtral-8x7b-32768'],fields:[
    {key:'api_key',label:'API Key',type:'password',placeholder:'gsk_...'},
    {key:'model',label:'Model',type:'text',placeholder:'llama-3.3-70b'},
    {key:'base_url',label:'Base URL (optional)',type:'text',placeholder:''},
  ]},
  {name:'ollama',label:'Ollama (Local)',icon:'ğŸ¦™',type:'local',models:['auto-detect'],fields:[
    {key:'model',label:'Model',type:'text',placeholder:'qwen3:0.6b'},
  ]},
  {name:'llamacpp',label:'llama.cpp',icon:'ğŸ”§',type:'local',models:['server endpoint'],fields:[
    {key:'base_url',label:'Server URL',type:'text',placeholder:'http://localhost:8080'},
    {key:'model',label:'Model',type:'text',placeholder:'(auto-detected)'},
  ]},
  {name:'brain',label:'Brain Engine',icon:'ğŸ§²',type:'local',models:['GGUF offline'],fields:[
    {key:'model_path',label:'Model Path (.gguf)',type:'text',placeholder:'~/.bizclaw/models/tinyllama.gguf'},
    {key:'threads',label:'Threads',type:'number',placeholder:'4'},
  ]},
  {name:'cliproxy',label:'CLIProxyAPI',icon:'ğŸ”Œ',type:'proxy',models:['OpenAI-compatible proxy'],fields:[
    {key:'base_url',label:'Proxy URL (báº¯t buá»™c)',type:'text',placeholder:'http://localhost:8787/v1'},
    {key:'api_key',label:'API Key (náº¿u proxy yÃªu cáº§u)',type:'password',placeholder:'proxy-key-...'},
    {key:'model',label:'Model',type:'text',placeholder:'gpt-4o-mini'},
  ]},
];
// â•â•â• CLIProxy Persistence â•â•â•
// CLIProxyAPI proxies through openai provider. We persist 'cliproxy' state in localStorage
// because Rust config only knows openai+base_url. This distinguishes CLIProxy from OpenAI+custom URL.
function isClipProxyActive(c) {
  if (!c) return false;
  const flag = localStorage.getItem('bizclaw_cliproxy');
  if (flag !== 'true') return false;
  const provider = c.default_provider || 'openai';
  const url = c.api_base_url || '';
  return provider === 'openai' && url && !url.includes('api.openai.com');
}
function setClipProxyFlag(active) {
  if (active) localStorage.setItem('bizclaw_cliproxy', 'true');
  else localStorage.removeItem('bizclaw_cliproxy');
}

function renderProviderCards() {
  const c = configData;
  const activeProvider = c.default_provider || 'openai';
  const activeModel = c.default_model || '';
  const proxyUrl = c.api_base_url || '';
  const isClipActive = isClipProxyActive(c);
  document.getElementById('prov-active-name').textContent = isClipActive ? 'CLIProxyAPI' : activeProvider;
  document.getElementById('prov-active-model').textContent = activeModel || '\u2014';
  document.getElementById('prov-total').textContent = PROVIDERS_META.length;
  const cloudLabel = t('providers.type_cloud');
  const localLabel = t('providers.type_local');
  const proxyLabel = t('providers.type_proxy') || 'Proxy';
  const activeLabel = t('providers.badge_active');
  const activateBtn = t('providers.btn_activate');
  const activeBtn = t('providers.btn_active');
  document.getElementById('providers-grid').innerHTML = PROVIDERS_META.map(p => {
    const isActive = p.name === 'cliproxy' ? isClipActive : (p.name === activeProvider && !isClipActive);
    const savedKey = c.api_key_set && isActive;
    const typeLabel = p.type === 'cloud' ? cloudLabel : (p.type === 'proxy' ? proxyLabel : localLabel);
    const fieldVals = {};
    if (isActive) {
      p.fields.forEach(f => {
        if (f.key === 'api_key') fieldVals[f.key] = savedKey ? '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022' : '';
        else if (f.key === 'model') fieldVals[f.key] = activeModel;
        else if (f.key === 'base_url') fieldVals[f.key] = proxyUrl;
        else if (f.key === 'model_path') fieldVals[f.key] = (c.brain||{}).model_path || '';
        else if (f.key === 'threads') fieldVals[f.key] = (c.brain||{}).threads || 4;
      });
    }
    return `<div class="ch-card" style="${isActive?'border-color:var(--accent);box-shadow:0 0 24px rgba(99,102,241,.15)':''}">
      <div class="ch-header">
        <span class="ch-name">${p.icon} ${p.label}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge badge-${isActive?'green':p.type==='proxy'?'purple':'blue'}">${isActive?'\u25cf '+activeLabel:typeLabel}</span>
        </div>
      </div>
      <div style="font-size:11px;color:var(--text2);margin-bottom:10px">${p.models.join(', ')}</div>
      <div class="ch-fields">
        ${p.fields.map(f => {
          const val = fieldVals[f.key] || '';
          return `<label>${f.label}</label><input type="${f.type||'text'}" id="prov-${p.name}-${f.key}" value="${val}" placeholder="${f.placeholder}">`;
        }).join('')}
      </div>
      ${p.name === 'cliproxy' ? '<div style="font-size:11px;color:var(--cyan);margin-bottom:8px;padding:6px 8px;background:rgba(34,211,238,.06);border-radius:6px">\ud83d\udca1 Proxy OpenAI-compatible APIs: LiteLLM, LocalAI, vLLM, text-gen-webui, Claw, etc.</div>' : ''}
      <div class="ch-actions">
        <button class="btn ${isActive?'btn-green':'btn-primary'} btn-sm" onclick="setActiveProvider('${p.name}')">${isActive?activeBtn:activateBtn}</button>
        ${isActive && p.name === 'cliproxy' ? '<button class="btn btn-outline btn-sm" onclick="testClipProxy()">\ud83e\uddea Test</button>' : ''}
      </div>
    </div>`;
  }).join('');
}

async function testClipProxy() {
  const url = configData.api_base_url;
  if (!url) { toast('\u274c Ch\u01b0a c\u1ea5u h\u00ecnh Proxy URL'); return; }
  toast('\ud83d\udd04 \u0110ang ki\u1ec3m tra k\u1ebft n\u1ed1i...');
  try {
    const testUrl = url.replace(/\/v1\/?$/, '') + '/v1/models';
    const res = await fetch(testUrl, { signal: AbortSignal.timeout(8000) });
    if (res.ok) {
      const data = await res.json();
      const models = (data.data || []).map(m => m.id).slice(0, 5).join(', ');
      toast('\u2705 Proxy ho\u1ea1t \u0111\u1ed9ng! Models: ' + (models || '(none listed)'));
    } else {
      toast('\u26a0\ufe0f Proxy tr\u1ea3 v\u1ec1 HTTP ' + res.status);
    }
  } catch(e) {
    toast('\u274c Kh\u00f4ng k\u1ebft n\u1ed1i \u0111\u01b0\u1ee3c: ' + e.message);
  }
}

async function setActiveProvider(name) {
  const meta = PROVIDERS_META.find(p => p.name === name);
  if (!meta) return;
  const actualProvider = name === 'cliproxy' ? 'openai' : name;
  const body = { default_provider: actualProvider };
  meta.fields.forEach(f => {
    const el = document.getElementById('prov-' + name + '-' + f.key);
    if (!el) return;
    const val = el.value.trim();
    if (!val || val.startsWith('\u2022')) return;
    if (f.key === 'api_key') body.api_key = val;
    else if (f.key === 'model') body.default_model = val;
    else if (f.key === 'base_url') body.api_base_url = val;
    else if (f.key === 'model_path') { body.brain = body.brain || {}; body.brain.model_path = val; body.brain.enabled = true; body.default_model = 'brain-local'; }
    else if (f.key === 'threads') { body.brain = body.brain || {}; body.brain.threads = parseInt(val) || 4; }
  });
  if (name === 'cliproxy' && !body.api_base_url) {
    toast('\u274c CLIProxyAPI c\u1ea7n Proxy URL!'); return;
  }
  if (!body.default_model) {
    if (name === 'brain') body.default_model = 'brain-local';
    else body.default_model = meta.models[0] || '';
  }
  // Persist CLIProxy flag to localStorage (survives page reload)
  setClipProxyFlag(name === 'cliproxy');
  try {
    const res = await authFetch(API + '/api/v1/config/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    if (r.ok) {
      toast('\u2705 Provider ' + (name === 'cliproxy' ? 'CLIProxyAPI' : name) + ' activated!');
      await loadConfig();
      renderProviderCards();
      loadDashboard();
    } else { toast('\u274c ' + r.error); }
  } catch(e) { toast('\u274c ' + e.message); }
}

async function loadProviders() {
  renderProviderCards();
}

// â•â•â• SETTINGS â•â•â•
async function loadConfig() {
  try {
    configData = await (await authFetch(API + '/api/v1/config')).json();
  } catch(e) { configData = {}; }
}

// Scan for GGUF model files using real API
async function scanBrainModels() {
  const listEl = document.getElementById('brain-models-list');
  const wrapEl = document.getElementById('brain-models-found');
  listEl.innerHTML = '<span style="color:var(--text2)">Scanning filesystem for GGUF models...</span>';
  wrapEl.style.display = '';
  try {
    const res = await authFetch(API + '/api/v1/brain/models');
    const data = await res.json();
    if (!data.ok) {
      listEl.innerHTML = `<span style="color:var(--red)">Error: ${data.error || 'Unknown error'}</span>`;
      return;
    }
    
    const currentPath = document.getElementById('set-brain-path').value;
    const models = data.models || [];
    
    if (models.length === 0) {
      listEl.innerHTML = `<div style="width:100%;font-size:12px">
        <span style="color:var(--text2)">No GGUF models found.</span><br>
        <span style="font-size:11px;color:var(--text2)">Download a model: <code style="color:var(--cyan)">bizclaw brain download tinyllama-1.1b</code></span><br>
        <span style="font-size:11px;color:var(--text2)">Models directory: <code>${data.models_dir}</code></span>
      </div>`;
      return;
    }
    
    listEl.innerHTML = models.map(m => {
      const isActive = m.path === currentPath;
      return `<button class="btn ${isActive ? 'btn-primary' : 'btn-outline'} btn-sm" 
        onclick="document.getElementById('set-brain-path').value='${m.path}'" 
        style="font-size:11px" title="${m.path}">${m.name} (${m.size})</button>`;
    }).join('') + `<div style="width:100%;font-size:11px;color:var(--text2);margin-top:4px">
      ğŸ“ Found ${models.length} model(s) in: ${(data.scan_dirs || []).join(', ')}
    </div>`;
  } catch(e) {
    listEl.innerHTML = `<span style="color:var(--red)">Error: ${e.message}</span>`;
  }
}

// Provider-specific form visibility
function onProviderChange() {
  const provider = document.getElementById('set-provider').value;
  // Hide all provider-specific sections
  ['cloud','ollama','brain','llamacpp'].forEach(id => {
    const el = document.getElementById('provider-'+id+'-fields');
    if(el) el.style.display = 'none';
  });
  // Show the relevant one
  if (provider === 'brain') {
    document.getElementById('provider-brain-fields').style.display = '';
  } else if (provider === 'ollama') {
    document.getElementById('provider-ollama-fields').style.display = '';
    loadOllamaModels();
  } else if (provider === 'llamacpp') {
    document.getElementById('provider-llamacpp-fields').style.display = '';
  } else {
    document.getElementById('provider-cloud-fields').style.display = '';
  }
}

let _ollamaModelsLoaded = false;
async function loadOllamaModels() {
  const sel = document.getElementById('set-ollama-model');
  const statusEl = document.getElementById('ollama-status-msg');
  const currentModel = configData.default_provider === 'ollama' ? configData.default_model : '';
  sel.innerHTML = '<option value="">â³ Loading...</option>';
  statusEl.textContent = 'Checking Ollama...';
  try {
    const res = await authFetch(API + '/api/v1/ollama/models');
    const r = await res.json();
    if (r.ok && r.models && r.models.length > 0) {
      sel.innerHTML = r.models.map(m =>
        `<option value="${m.name}" ${m.name === currentModel ? 'selected' : ''}>${m.name} (${m.size})</option>`
      ).join('');
      statusEl.innerHTML = `<span style="color:var(--green)">âœ… Ollama running â€” ${r.models.length} models available</span>`;
      _ollamaModelsLoaded = true;
    } else if (r.ok && (!r.models || r.models.length === 0)) {
      sel.innerHTML = '<option value="">No models installed</option>';
      statusEl.innerHTML = '<span style="color:var(--orange)">âš ï¸ Ollama running but no models. Run: <code style="color:var(--cyan)">ollama pull tinyllama</code></span>';
    } else {
      sel.innerHTML = '<option value="">Ollama not available</option>';
      statusEl.innerHTML = `<span style="color:var(--red)">âŒ ${r.error || 'Cannot connect to Ollama'}</span>`;
    }
  } catch(e) {
    sel.innerHTML = '<option value="">Connection error</option>';
    statusEl.innerHTML = `<span style="color:var(--red)">âŒ ${e.message}</span>`;
  }
}

function loadSettingsForm() {
  const c = configData;
  if (!c.default_provider) return;
  const provider = c.default_provider || 'openai';
  document.getElementById('set-provider').value = provider;
  document.getElementById('set-temp').value = c.default_temperature || 0.7;
  // Fill model & API key for cloud providers
  document.getElementById('set-model').value = c.default_model || '';
  document.getElementById('set-apikey').value = c.api_key_set ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
  document.getElementById('set-baseurl').value = c.api_base_url || '';
  // Fill Brain fields
  const brain = c.brain || {};
  document.getElementById('set-brain-path').value = brain.model_path || '';
  document.getElementById('set-brain-threads').value = brain.threads || 4;
  // Toggle visibility (also triggers loadOllamaModels if provider is ollama)
  onProviderChange();
  // After loading ollama models, select the current one
  if (provider === 'ollama' && c.default_model) {
    // Wait for models to load then select
    setTimeout(() => {
      const sel = document.getElementById('set-ollama-model');
      if (sel) sel.value = c.default_model;
    }, 1500);
  }
  // Identity
  const id = c.identity || {};
  document.getElementById('set-name').value = id.name || '';
  document.getElementById('set-persona').value = id.persona || '';
  document.getElementById('set-sysprompt').value = id.system_prompt || '';
  // Memory
  const mem = c.memory || {};
  document.getElementById('set-mem-backend').value = mem.backend || 'sqlite';
  document.getElementById('set-mem-autosave').value = String(mem.auto_save !== false);
  // Autonomy
  const auto = c.autonomy || {};
  document.getElementById('set-auto-level').value = auto.level || 'supervised';
  document.getElementById('set-auto-workspace').value = String(auto.workspace_only !== false);
}

async function saveSettings() {
  const provider = document.getElementById('set-provider').value;
  let modelVal = '';
  if (provider === 'brain') {
    modelVal = 'brain-local';
  } else if (provider === 'ollama') {
    modelVal = document.getElementById('set-ollama-model').value;
  } else if (provider === 'llamacpp') {
    modelVal = document.getElementById('set-llamacpp-model').value;
  } else {
    modelVal = document.getElementById('set-model').value;
  }
  const body = {
    default_provider: provider,
    default_model: modelVal,
    default_temperature: parseFloat(document.getElementById('set-temp').value),
    identity: {
      name: document.getElementById('set-name').value,
      persona: document.getElementById('set-persona').value,
      system_prompt: document.getElementById('set-sysprompt').value,
    },
    memory: {
      backend: document.getElementById('set-mem-backend').value,
      auto_save: document.getElementById('set-mem-autosave').value === 'true',
    },
    autonomy: {
      level: document.getElementById('set-auto-level').value,
      workspace_only: document.getElementById('set-auto-workspace').value === 'true',
    },
  };
  // Provider-specific fields â€” always send brain config to persist model_path
  if (provider === 'brain') {
    body.brain = {
      enabled: true,
      model_path: document.getElementById('set-brain-path').value,
      threads: parseInt(document.getElementById('set-brain-threads').value) || 4,
    };
  }
  const apiKeyVal = document.getElementById('set-apikey').value;
  if (apiKeyVal && !apiKeyVal.startsWith('â€¢') && !['brain','ollama','llamacpp'].includes(provider)) {
    body.api_key = apiKeyVal;
  }
  const baseUrlVal = document.getElementById('set-baseurl').value.trim();
  body.api_base_url = baseUrlVal;
  try {
    const res = await authFetch(API + '/api/v1/config/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    if (r.ok) {
      toast('âœ… Settings saved! Agent reloading...');
      // Reload config from server to ensure UI shows persisted values
      await loadConfig();
      loadSettingsForm();
      loadDashboard();
    } else {
      toast('âŒ ' + r.error);
    }
  } catch(e) { toast('âŒ ' + e.message); }
}

// â•â•â• CHANNELS â•â•â•
const CHANNELS = [
  {type:'telegram',name:'Telegram Bot',icon:'ğŸ¤–',fields:[
    {key:'bot_token',label:'Bot Token',type:'password',placeholder:'123456:ABC-DEF...', masked:true},
    {key:'allowed_chat_ids',label:'Allowed Chat IDs',type:'text',placeholder:'123456789, -100123...'},
  ]},
  {type:'zalo',name:'Zalo Personal',icon:'ğŸ’¬',hasQR:true,fields:[
    {key:'cookie',label:'Zalo Cookie',type:'textarea',placeholder:'Paste cookie tá»« chat.zalo.me â†’ F12 â†’ Application â†’ Cookies'},
    {key:'imei',label:'IMEI',type:'text',placeholder:'Tá»± Ä‘á»™ng táº¡o náº¿u Ä‘á»ƒ trá»‘ng'},
  ]},
  {type:'zalo_oa',name:'Zalo OA Bot',icon:'ğŸ‡»ğŸ‡³',fields:[
    {key:'bot_token',label:'Bot Token',type:'password',placeholder:'Token tá»« Zalo Bot Creator (bot.zapps.me)', masked:true},
    {key:'webhook_url',label:'Webhook URL',type:'text',placeholder:'https://your-domain.com/api/v1/zalo-oa/webhook'},
  ]},
  {type:'discord',name:'Discord Bot',icon:'ğŸ®',fields:[
    {key:'bot_token',label:'Bot Token',type:'password',placeholder:'MTk...', masked:true},
    {key:'allowed_channel_ids',label:'Channel IDs',type:'text',placeholder:'123456789, 987654321'},
  ]},
  {type:'email',name:'Email (SMTP)',icon:'ğŸ“§',fields:[
    {key:'smtp_host',label:'SMTP Host',type:'text',placeholder:'smtp.gmail.com'},
    {key:'smtp_port',label:'Port',type:'text',placeholder:'587'},
    {key:'smtp_user',label:'Username',type:'text',placeholder:'agent@company.com'},
    {key:'smtp_pass',label:'Password',type:'password',placeholder:'App password', masked:true},
  ]},
  {type:'whatsapp',name:'WhatsApp Business',icon:'ğŸ“²',fields:[
    {key:'phone_number_id',label:'Phone Number ID',type:'text',placeholder:'Cloud API Phone ID'},
    {key:'access_token',label:'Access Token',type:'password',placeholder:'EAAG...', masked:true},
    {key:'webhook_verify_token',label:'Webhook Verify Token',type:'text',placeholder:'my_verify_token'},
  ]},
  {type:'webhook',name:'Webhook API',icon:'ğŸ”—',fields:[
    {key:'webhook_url',label:'Inbound URL',type:'text',placeholder:'https://your-app.com/webhook'},
    {key:'webhook_secret',label:'Secret',type:'password',placeholder:'shared secret for HMAC'},
  ]},
  {type:'slack',name:'Slack Bot',icon:'ğŸ’¼',fields:[
    {key:'bot_token',label:'Bot Token (xoxb-)',type:'password',placeholder:'xoxb-...', masked:true},
    {key:'app_token',label:'App Token (xapp-)',type:'password',placeholder:'xapp-...', masked:true},
    {key:'allowed_channel_ids',label:'Channel IDs',type:'text',placeholder:'C01ABCDEF, C02GHIJKL'},
  ]},
];

function renderChannelCards() {
  const ch = configData.channels || {};
  document.getElementById('channels-grid').innerHTML = CHANNELS.map(def => {
    const saved = ch[def.type];
    const enabled = saved && saved.enabled !== undefined ? saved.enabled : false;
    return `<div class="ch-card">
      <div class="ch-header">
        <span class="ch-name">${def.icon} ${def.name}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge badge-${enabled?'green':'orange'}">${enabled?'Active':'Disabled'}</span>
          <label class="toggle"><input type="checkbox" id="ch-toggle-${def.type}" ${enabled?'checked':''}><span class="slider"></span></label>
        </div>
      </div>
      <div class="ch-fields">
        ${def.fields.map(f => {
          let val = (saved && saved[f.key]) || '';
          // For masked fields (tokens/passwords), show indicator but keep actual input empty
          // so user can type new value. Don't pre-fill masked values.
          const isMaskedValue = f.masked && val && (val.includes('â€¢') || val === 'â€¢â€¢â€¢â€¢');
          const indicator = isMaskedValue ? '<span style="font-size:10px;color:var(--green)"> âœ… saved</span>' : (f.masked && saved && saved[f.key+'_set'] ? '<span style="font-size:10px;color:var(--green)"> âœ… saved</span>' : '');
          const displayVal = isMaskedValue ? '' : val;
          if (f.type === 'textarea') return `<label>${f.label}${indicator}</label><textarea id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}">${displayVal}</textarea>`;
          return `<label>${f.label}${indicator}</label><input type="${f.type}" id="ch-${def.type}-${f.key}" value="${displayVal}" placeholder="${f.placeholder}">`;
        }).join('')}
      </div>
      <div class="ch-actions">
        <button class="btn btn-primary btn-sm" onclick="saveChannel('${def.type}')">ğŸ’¾ Save</button>
        ${def.hasQR ? '<button class="btn btn-green btn-sm" onclick="openZaloQR()">ğŸ“± QuÃ©t mÃ£ QR</button>' : ''}
      </div>
    </div>`;
  }).join('');
}

async function saveChannel(type) {
  const def = CHANNELS.find(c => c.type === type);
  if (!def) return;
  const body = {
    channel_type: type,
    enabled: document.getElementById('ch-toggle-' + type)?.checked || false,
  };
  def.fields.forEach(f => {
    const el = document.getElementById('ch-' + type + '-' + f.key);
    if (el) body[f.key] = el.value;
  });
  try {
    const res = await authFetch(API + '/api/v1/channels/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    toast(r.ok ? `âœ… ${type} config saved` : 'âŒ ' + r.error);
    if (r.ok) { await loadConfig(); renderChannelCards(); }
  } catch(e) { toast('âŒ ' + e.message); }
}

async function openZaloQR() {
  const modal = document.getElementById('zalo-qr-modal');
  modal.style.display = 'flex';
  document.getElementById('zalo-qr-content').innerHTML = '<div class="pulse" style="color:var(--text2)">Äang káº¿t ná»‘i Ä‘áº¿n Zalo...</div>';
  try {
    const res = await authFetch(API + '/api/v1/zalo/qr', {method:'POST',headers:{'Content-Type':'application/json'}});
    const r = await res.json();
    if (r.ok) {
      toast('âœ… MÃ£ QR Ä‘Ã£ táº¡o thÃ nh cÃ´ng! QuÃ©t báº±ng Zalo.');
      document.getElementById('zalo-qr-content').innerHTML = r.qr_code.startsWith('data:') 
        ? `<img src="${r.qr_code}" style="max-width:280px;border-radius:12px;border:2px solid var(--accent)">`
        : `<div style="background:#fff;padding:16px;border-radius:12px;display:inline-block"><div style="font-family:var(--mono);font-size:11px;word-break:break-all;color:#333;max-width:260px">${r.qr_code}</div></div>`;
      document.getElementById('zalo-qr-instructions').innerHTML = (r.instructions||[]).map(i => `<div style="margin:3px 0">${i}</div>`).join('')
        + `<div style="margin-top:12px"><button class="btn btn-green" onclick="confirmZaloQR('${r.imei||''}')">âœ… XÃ¡c nháº­n Ä‘Ã£ quÃ©t thÃ nh cÃ´ng</button></div>`;
      document.getElementById('zalo-qr-imei').textContent = r.imei ? `IMEI: ${r.imei}` : '';
      // Auto-fill IMEI into channel card
      const imeiEl = document.getElementById('ch-zalo-imei');
      if (imeiEl && r.imei) imeiEl.value = r.imei;
    } else {
      document.getElementById('zalo-qr-content').innerHTML = `<div style="color:var(--red)">âŒ ${r.error}</div><div style="margin-top:12px;font-size:12px;color:var(--text2)">${r.fallback||''}</div>`;
    }
  } catch(e) {
    document.getElementById('zalo-qr-content').innerHTML = `<div style="color:var(--red)">Lá»—i káº¿t ná»‘i: ${e.message}</div>`;
  }
}

async function confirmZaloQR(imei) {
  // Save zalo channel as enabled with the IMEI from QR
  const body = { channel_type: 'zalo', enabled: true, imei: imei };
  try {
    const res = await authFetch(API + '/api/v1/channels/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    if (r.ok) {
      toast('ğŸ‰ Zalo Ä‘Ã£ káº¿t ná»‘i thÃ nh cÃ´ng!');
      closeZaloQR();
      await loadConfig();
      renderChannelCards();
    } else {
      toast('âŒ ' + r.error);
    }
  } catch(e) { toast('âŒ ' + e.message); }
}

function closeZaloQR() {
  document.getElementById('zalo-qr-modal').style.display = 'none';
}

// â•â•â• CONFIG TOML â•â•â•
async function loadConfigToml() {
  try {
    const data = await (await authFetch(API + '/api/v1/config/full')).json();
    document.getElementById('config-toml-content').textContent = data.toml || 'No config loaded';
    document.getElementById('config-path').textContent = data.config_path || '';
  } catch(e) {}
}

// â•â•â• MCP SERVERS â•â•â•
function loadMcpServers() {
  const servers = configData.mcp_servers || [];
  document.getElementById('mcp-total').textContent = servers.length;
  document.getElementById('mcp-active').textContent = servers.filter(s => s.enabled !== false).length;
  renderMcpList(servers);
}

function renderMcpList(servers) {
  const el = document.getElementById('mcp-list');
  if (!servers.length) {
    el.innerHTML = '<div class="card" style="text-align:center;padding:30px;color:var(--text2)">ğŸ”— No MCP servers configured yet.<br>Click "+ Add Server" to connect external tools.</div>';
    return;
  }
  el.innerHTML = servers.map((s, i) => `<div class="ch-card">
    <div class="ch-header">
      <span class="ch-name">ğŸ”— ${s.name}</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="badge badge-${s.enabled !== false ? 'green' : 'orange'}">${s.enabled !== false ? 'Active' : 'Disabled'}</span>
        <label class="toggle"><input type="checkbox" ${s.enabled !== false ? 'checked' : ''} onchange="toggleMcp(${i}, this.checked)"><span class="slider"></span></label>
      </div>
    </div>
    <div class="ch-fields" style="font-size:12px;">
      <div><strong>Command:</strong> <code>${s.command} ${(s.args||[]).join(' ')}</code></div>
      ${Object.keys(s.env||{}).length ? '<div><strong>Env:</strong> ' + Object.keys(s.env).map(k => k + '=â€¢â€¢â€¢').join(', ') + '</div>' : ''}
    </div>
    <div class="ch-actions" style="margin-top:8px">
      <button class="btn btn-danger btn-sm" onclick="removeMcp(${i})">ğŸ—‘ï¸ Remove</button>
    </div>
  </div>`).join('');
}

function showMcpForm() { document.getElementById('mcp-add-form').style.display = ''; }
function hideMcpForm() { document.getElementById('mcp-add-form').style.display = 'none'; }

async function addMcpServer() {
  const name = document.getElementById('mcp-name').value.trim();
  const command = document.getElementById('mcp-command').value.trim();
  const argsStr = document.getElementById('mcp-args').value.trim();
  const envStr = document.getElementById('mcp-env').value.trim();
  if (!name || !command) { toast('Name and command are required', 'error'); return; }
  
  const args = argsStr ? argsStr.split(',').map(s => s.trim()).filter(Boolean) : [];
  const env = {};
  envStr.split('\n').forEach(line => {
    const [k, ...v] = line.split('=');
    if (k && v.length) env[k.trim()] = v.join('=').trim();
  });
  
  const servers = configData.mcp_servers || [];
  servers.push({ name, command, args, env, enabled: true });
  
  try {
    const res = await authFetch(API + '/api/v1/config/update', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ mcp_servers: servers })
    });
    const r = await res.json();
    if (r.ok) {
      toast('âœ… MCP server added: ' + name);
      hideMcpForm();
      // Clear form
      ['mcp-name','mcp-command','mcp-args','mcp-env'].forEach(id => document.getElementById(id).value = '');
      await loadConfig();
      loadMcpServers();
    } else { toast('âŒ ' + r.error, 'error'); }
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

async function removeMcp(index) {
  const servers = (configData.mcp_servers || []).filter((_, i) => i !== index);
  try {
    const res = await authFetch(API + '/api/v1/config/update', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ mcp_servers: servers })
    });
    const r = await res.json();
    if (r.ok) { toast('ğŸ—‘ï¸ Server removed'); await loadConfig(); loadMcpServers(); }
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

async function toggleMcp(index, enabled) {
  const servers = configData.mcp_servers || [];
  if (servers[index]) servers[index].enabled = enabled;
  try {
    const res = await authFetch(API + '/api/v1/config/update', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ mcp_servers: servers })
    });
    const r = await res.json();
    if (r.ok) { toast(enabled ? 'âœ… Server enabled' : 'â¸ Server disabled'); await loadConfig(); loadMcpServers(); }
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

// â•â•â• ONBOARDING WIZARD â•â•â•
function checkOnboarding() {
  if (!localStorage.getItem('bizclaw_onboarded')) {
    const overlay = document.getElementById('onboard-overlay');
    overlay.style.display = 'flex';
  }
}
function skipOnboard() {
  localStorage.setItem('bizclaw_onboarded', '1');
  document.getElementById('onboard-overlay').style.display = 'none';
}
function onboardNext() {
  document.getElementById('onboard-step-1').style.display = 'none';
  document.getElementById('onboard-step-2').style.display = '';
}
function onboardProviderChange() {
  const p = document.getElementById('onboard-provider').value;
  document.getElementById('onboard-cloud-fields').style.display = ['ollama','brain','llamacpp'].includes(p) ? 'none' : '';
  document.getElementById('onboard-ollama-info').style.display = p === 'ollama' ? '' : 'none';
}
async function finishOnboard() {
  const provider = document.getElementById('onboard-provider').value;
  const model = document.getElementById('onboard-model')?.value || '';
  const apiKey = document.getElementById('onboard-apikey')?.value || '';
  const baseUrl = document.getElementById('onboard-baseurl')?.value || '';
  const aboutUser = document.getElementById('onboard-about').value;
  const agentVibe = document.getElementById('onboard-vibe').value;
  const userName = document.getElementById('onboard-name').value;

  // Show done step
  document.getElementById('onboard-step-2').style.display = 'none';
  document.getElementById('onboard-step-done').style.display = '';
  const progress = document.getElementById('onboard-progress');

  // Step 1: Save provider config
  progress.innerHTML = 'âš™ï¸ Saving provider settings...';
  const configBody = { default_provider: provider };
  if (model) configBody.default_model = model;
  if (apiKey) configBody.api_key = apiKey;
  configBody.api_base_url = baseUrl;
  if (provider === 'ollama') {
    configBody.default_model = 'qwen3:0.6b';
  }
  try {
    await authFetch(API + '/api/v1/config/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(configBody)});
    progress.innerHTML = 'âœ… Provider configured!<br>ğŸ¨ Creating your agent personality...';
  } catch(e) {
    progress.innerHTML = 'âš ï¸ Config save error, continuing...';
  }

  // Step 2: Brain personalization (if user entered about)
  if (aboutUser.trim()) {
    // Wait for agent to reload with new config
    await new Promise(r => setTimeout(r, 3000));
    try {
      const res = await authFetch(API + '/api/v1/brain/personalize', {
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({about_user: aboutUser, agent_vibe: agentVibe, agent_name: userName || 'BizClaw Agent', language: currentLang})
      });
      const data = await res.json();
      if (data.ok) {
        progress.innerHTML = 'âœ… Agent personality created! (' + (data.saved||[]).join(', ') + ')<br><br><button class="btn btn-primary" onclick="skipOnboard();loadDashboard()">ğŸš€ Start using BizClaw</button>';
      } else {
        progress.innerHTML = 'âš ï¸ ' + (data.error||'AI not ready') + '<br><br><button class="btn btn-primary" onclick="skipOnboard();loadDashboard()">Continue anyway â†’</button>';
      }
    } catch(e) {
      progress.innerHTML = 'âš ï¸ Brain personalization skipped<br><br><button class="btn btn-primary" onclick="skipOnboard();loadDashboard()">Continue â†’</button>';
    }
  } else {
    progress.innerHTML = 'âœ… All set!<br><br><button class="btn btn-primary" onclick="skipOnboard();loadDashboard()">ğŸš€ Start using BizClaw</button>';
  }

  localStorage.setItem('bizclaw_onboarded', '1');
}

// Show onboarding on page load
setTimeout(checkOnboarding, 1000);

// â•â•â• BRAIN WORKSPACE EDITOR â•â•â•
let _brainEditFile = '';

async function loadBrainFiles() {
  try {
    const res = await authFetch(API + '/api/v1/brain/files');
    const data = await res.json();
    if (!data.ok) return;
    document.getElementById('brain-files-count').textContent = data.count || 0;
    document.getElementById('brain-base-dir').textContent = 'ğŸ“ ' + (data.base_dir || '~/.bizclaw');
    const list = document.getElementById('brain-files-list');
    list.innerHTML = '';
    (data.files || []).forEach(f => {
      const icon = f.is_custom ? 'ğŸ“' : (f.exists ? 'ğŸ“„' : 'â¬œ');
      const badge = f.exists ? `<span style="color:var(--green);font-size:12px">â— ${(f.size/1024).toFixed(1)}KB</span>` : '<span style="color:var(--orange);font-size:12px">â—‹ empty</span>';
      const card = document.createElement('div');
      card.className = 'card';
      card.style.cursor = 'pointer';
      card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${icon} ${f.filename}</strong>${badge}</div><div class="card-sub" style="margin-top:4px">${f.section}</div>`;
      card.onclick = () => openBrainEditor(f.filename, f.content);
      list.appendChild(card);
    });
  } catch(e) { console.warn('Brain files load error:', e); }
}

function openBrainEditor(filename, content) {
  _brainEditFile = filename;
  document.getElementById('brain-editor-title').textContent = 'ğŸ“„ ' + filename;
  document.getElementById('brain-editor-content').value = content || '';
  document.getElementById('brain-editor').style.display = '';
  document.getElementById('brain-editor-content').focus();
}

function closeBrainEditor() {
  document.getElementById('brain-editor').style.display = 'none';
  _brainEditFile = '';
}

async function saveBrainFile() {
  if (!_brainEditFile) return;
  const content = document.getElementById('brain-editor-content').value;
  try {
    const res = await authFetch(API + '/api/v1/brain/files/' + encodeURIComponent(_brainEditFile), {
      method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({content})
    });
    const data = await res.json();
    if (data.ok) { toast('ğŸ’¾ ' + _brainEditFile + ' saved'); loadBrainFiles(); }
    else toast('âŒ ' + (data.error||'Save failed'), 'error');
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

async function deleteBrainFile() {
  if (!_brainEditFile || !confirm('Delete ' + _brainEditFile + '?')) return;
  try {
    const res = await authFetch(API + '/api/v1/brain/files/' + encodeURIComponent(_brainEditFile), {method:'DELETE'});
    const data = await res.json();
    if (data.ok) { toast('ğŸ—‘ï¸ Deleted'); closeBrainEditor(); loadBrainFiles(); }
    else toast('âŒ ' + (data.error||''), 'error');
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

async function createBrainFile() {
  const name = document.getElementById('brain-new-filename').value.trim();
  if (!name) return toast('Enter a filename (e.g. CUSTOM.md)', 'error');
  const filename = name.endsWith('.md') ? name : name + '.md';
  try {
    const res = await authFetch(API + '/api/v1/brain/files/' + encodeURIComponent(filename), {
      method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({content: '# ' + filename.replace('.md','') + '\n\n'})
    });
    const data = await res.json();
    if (data.ok) { toast('âœ… Created: ' + filename); document.getElementById('brain-new-filename').value = ''; loadBrainFiles(); }
    else toast('âŒ ' + (data.error||''), 'error');
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

// â•â•â• HEALTH CHECK â•â•â•
async function runHealthCheck() {
  try {
    const res = await authFetch(API + '/api/v1/health');
    const data = await res.json();
    document.getElementById('health-results').style.display = '';
    const badge = data.status === 'healthy' ? 'ğŸŸ¢' : data.status === 'degraded' ? 'ğŸŸ¡' : 'ğŸ”´';
    document.getElementById('health-summary').innerHTML = `<span style="font-size:18px">${badge} <strong>${data.status.toUpperCase()}</strong></span> â€” Score: <strong>${data.score}</strong> (${data.score_pct}%)`;
    const body = document.getElementById('health-checks-body');
    body.innerHTML = '';
    (data.checks || []).forEach(c => {
      const color = c.status === 'pass' ? 'var(--green)' : c.status === 'fail' ? '#dc3545' : c.status === 'warn' ? 'var(--orange)' : 'var(--text-dim)';
      const icon = c.status === 'pass' ? 'âœ…' : c.status === 'fail' ? 'âŒ' : c.status === 'warn' ? 'âš ï¸' : 'â­ï¸';
      body.innerHTML += `<tr><td>${c.name}</td><td style="color:${color}">${icon} ${c.status}</td><td>${c.detail}</td></tr>`;
    });
    toast(`ğŸ©º Health: ${data.score} (${data.status})`);
  } catch(e) { toast('âŒ Health check failed: ' + e.message, 'error'); }
}

// â•â•â• MULTI-AGENT ORCHESTRATOR â•â•â•
function showCreateAgentForm() { document.getElementById('agent-create-form').style.display = ''; }

async function loadAgents() {
  try {
    const res = await authFetch(API + '/api/v1/agents');
    const data = await res.json();
    if (!data.ok) return;
    
    document.getElementById('agents-total').textContent = data.total || 0;
    document.getElementById('agents-default').textContent = data.default || 'â€”';
    document.getElementById('agents-messages').textContent = 
      (data.recent_messages || []).length;
    
    const list = document.getElementById('agents-list');
    if (!data.agents || data.agents.length === 0) {
      list.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:var(--text2)"><div style="font-size:48px;margin-bottom:12px">ğŸ¤–</div><div>No agents yet. Click <b>+ Create Agent</b> to build your AI team.</div></div>';
      return;
    }
    
    list.innerHTML = data.agents.map(a => `
      <div class="card" style="position:relative">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:24px">${a.role === 'coder' ? 'ğŸ’»' : a.role === 'researcher' ? 'ğŸ”¬' : a.role === 'writer' ? 'âœï¸' : a.role === 'analyst' ? 'ğŸ“Š' : a.role === 'translator' ? 'ğŸŒ' : 'ğŸ¤–'}</span>
          <div>
            <div style="font-weight:600;color:var(--text)">${a.name} ${a.is_default ? '<span style="font-size:10px;background:var(--accent);color:#000;padding:2px 6px;border-radius:8px">DEFAULT</span>' : ''}</div>
            <div style="font-size:11px;color:var(--text2)">${a.role} â€¢ ${a.provider} â€¢ ${a.tools} tools</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text2)">${a.description}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:6px">ğŸ’¬ ${a.messages_processed} messages â€¢ ğŸ“ ${a.conversation_length} in context</div>
        <div style="display:flex;gap:6px;margin-top:10px">
          <input id="agent-msg-${a.name}" placeholder="Chat with ${a.name}..." style="flex:1;font-size:12px">
          <button class="btn btn-primary btn-sm" onclick="chatWithAgent('${a.name}')" style="font-size:11px">Send</button>
          <button class="btn btn-outline btn-sm" onclick="deleteAgent('${a.name}')" style="font-size:11px;color:var(--red)">ğŸ—‘ï¸</button>
        </div>
        <div id="agent-response-${a.name}" style="margin-top:8px;font-size:12px;color:var(--cyan);display:none"></div>
      </div>
    `).join('');
  } catch(e) { console.error('Load agents:', e); }
}

async function createAgent() {
  const name = document.getElementById('new-agent-name').value.trim();
  const role = document.getElementById('new-agent-role').value;
  const desc = document.getElementById('new-agent-desc').value.trim();
  const prompt = document.getElementById('new-agent-prompt').value.trim();
  if (!name) { toast('Agent name is required', 'error'); return; }
  
  try {
    const res = await authFetch(API + '/api/v1/agents', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name, role, description: desc || `A ${role} agent`, system_prompt: prompt || undefined })
    });
    const r = await res.json();
    if (r.ok) {
      toast(`ğŸ¤– Agent '${name}' created!`);
      document.getElementById('agent-create-form').style.display = 'none';
      ['new-agent-name','new-agent-desc','new-agent-prompt'].forEach(id => document.getElementById(id).value = '');
      loadAgents();
    } else { toast('âŒ ' + r.error, 'error'); }
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

async function deleteAgent(name) {
  try {
    const res = await authFetch(API + `/api/v1/agents/${name}`, { method: 'DELETE' });
    const r = await res.json();
    toast(r.ok ? `ğŸ—‘ï¸ Agent '${name}' removed` : 'âŒ ' + r.message);
    loadAgents();
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

async function chatWithAgent(name) {
  const input = document.getElementById(`agent-msg-${name}`);
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  
  const respEl = document.getElementById(`agent-response-${name}`);
  respEl.style.display = '';
  respEl.innerHTML = '<span style="color:var(--text2)">Thinking...</span>';
  
  try {
    const res = await authFetch(API + `/api/v1/agents/${name}/chat`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: msg })
    });
    const r = await res.json();
    respEl.innerHTML = r.ok 
      ? `<div style="background:var(--bg);padding:8px;border-radius:8px;border:1px solid var(--border)">${r.response.replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>`
      : `<span style="color:var(--red)">âŒ ${r.error}</span>`;
  } catch(e) { respEl.innerHTML = `<span style="color:var(--red)">âŒ ${e.message}</span>`; }
}

async function broadcastMessage() {
  const msg = document.getElementById('broadcast-msg').value.trim();
  if (!msg) { toast('Enter a message to broadcast', 'error'); return; }
  
  const el = document.getElementById('broadcast-results');
  el.innerHTML = '<span style="color:var(--text2)">Broadcasting...</span>';
  
  try {
    const res = await authFetch(API + '/api/v1/agents/broadcast', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: msg })
    });
    const r = await res.json();
    if (r.ok) {
      el.innerHTML = r.responses.map(resp => `
        <div style="margin-top:8px;padding:8px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
          <div style="font-weight:600;color:${resp.ok ? 'var(--cyan)' : 'var(--red)'}">${resp.agent}</div>
          <div style="font-size:12px;margin-top:4px">${(resp.ok ? resp.response : resp.error).replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>
        </div>
      `).join('');
    }
  } catch(e) { el.innerHTML = `<span style="color:var(--red)">\u274c ${e.message}</span>`; }
}

// \u2550\u2550\u2550 AGENT GROUP CHAT \u2550\u2550\u2550
let _groups = JSON.parse(localStorage.getItem('bizclaw_groups') || '[]');
let _activeGroupIdx = -1;

function saveGroups() {
  localStorage.setItem('bizclaw_groups', JSON.stringify(_groups));
}

async function showCreateGroupForm() {
  document.getElementById('group-create-form').style.display = '';
  try {
    const res = await authFetch(API + '/api/v1/agents');
    const data = await res.json();
    const container = document.getElementById('group-agent-checkboxes');
    if (!data.ok || !data.agents || data.agents.length === 0) {
      container.innerHTML = '<span style="color:var(--orange);font-size:12px">\u26a0\ufe0f Ch\u01b0a c\u00f3 agent n\u00e0o. V\u00e0o trang \u0110a t\u00e1c t\u1eed \u0111\u1ec3 t\u1ea1o.</span>';
      return;
    }
    container.innerHTML = data.agents.map(a => {
      const icon = a.role === 'coder' ? '\ud83d\udcbb' : a.role === 'researcher' ? '\ud83d\udd2c' : a.role === 'writer' ? '\u270d\ufe0f' : a.role === 'analyst' ? '\ud83d\udcca' : '\ud83e\udd16';
      return `<label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px">
        <input type="checkbox" value="${a.name}" class="group-agent-cb"> ${icon} ${a.name} <span style="color:var(--text2);font-size:10px">(${a.role})</span>
      </label>`;
    }).join('');
  } catch(e) {
    document.getElementById('group-agent-checkboxes').innerHTML = '<span style="color:var(--red)">\u274c ' + e.message + '</span>';
  }
}

function createGroup() {
  const name = document.getElementById('new-group-name').value.trim();
  const topic = document.getElementById('new-group-topic').value.trim();
  if (!name) { toast('Nh\u1eadp t\u00ean nh\u00f3m'); return; }
  const agents = [...document.querySelectorAll('.group-agent-cb:checked')].map(cb => cb.value);
  if (agents.length < 2) { toast('Ch\u1ecdn \u00edt nh\u1ea5t 2 agent cho nh\u00f3m'); return; }
  _groups.push({
    name,
    topic: topic || 'General discussion',
    agents,
    messages: [],
    created: new Date().toISOString(),
  });
  saveGroups();
  toast('\ud83d\udc65 Nh\u00f3m "' + name + '" \u0111\u00e3 t\u1ea1o v\u1edbi ' + agents.length + ' agents!');
  document.getElementById('group-create-form').style.display = 'none';
  ['new-group-name', 'new-group-topic'].forEach(id => document.getElementById(id).value = '');
  renderGroups();
}

function renderGroups() {
  document.getElementById('groups-total').textContent = _groups.length;
  document.getElementById('groups-agents').textContent = _groups.reduce((s, g) => s + g.agents.length, 0);
  document.getElementById('groups-convos').textContent = _groups.reduce((s, g) => s + g.messages.length, 0);
  const list = document.getElementById('groups-list');
  if (_groups.length === 0) {
    list.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:var(--text2)"><div style="font-size:48px;margin-bottom:12px">\ud83d\udc65</div><div>Ch\u01b0a c\u00f3 nh\u00f3m n\u00e0o. T\u1ea1o nh\u00f3m Agent \u0111\u1ec3 ch\u00fang c\u00f9ng trao \u0111\u1ed5i, ph\u00e2n t\u00edch v\u00e0 ph\u1ed1i h\u1ee3p.</div></div>';
    return;
  }
  list.innerHTML = _groups.map((g, i) => {
    const agentIcons = g.agents.map(a => '<span style="background:var(--bg2);padding:2px 8px;border-radius:4px;font-size:11px">\ud83e\udd16 ' + a + '</span>').join(' ');
    return `<div class="ch-card">
      <div class="ch-header">
        <span class="ch-name">\ud83d\udc65 ${g.name}</span>
        <span class="badge badge-blue">${g.agents.length} agents</span>
      </div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:8px">\ud83d\udccb ${g.topic}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">${agentIcons}</div>
      <div style="font-size:11px;color:var(--text2);margin-bottom:10px">\ud83d\udcac ${g.messages.length} tin nh\u1eafn \u2022 ${new Date(g.created).toLocaleDateString()}</div>
      <div class="ch-actions">
        <button class="btn btn-primary btn-sm" onclick="openGroupChat(${i})">\ud83d\udcac M\u1edf nh\u00f3m</button>
        <button class="btn btn-outline btn-sm" style="color:var(--red)" onclick="deleteGroup(${i})">\ud83d\uddd1\ufe0f</button>
      </div>
    </div>`;
  }).join('');
}

function deleteGroup(idx) {
  if (!confirm('X\u00f3a nh\u00f3m "' + _groups[idx].name + '"?')) return;
  _groups.splice(idx, 1);
  saveGroups();
  renderGroups();
  toast('\ud83d\uddd1\ufe0f \u0110\u00e3 x\u00f3a nh\u00f3m');
}

function openGroupChat(idx) {
  _activeGroupIdx = idx;
  const g = _groups[idx];
  document.getElementById('group-chat-title').textContent = '\ud83d\udc65 ' + g.name;
  document.getElementById('group-chat-members').textContent = '\ud83d\udc64 Th\u00e0nh vi\u00ean: ' + g.agents.join(', ') + ' \u2022 \ud83d\udccb ' + g.topic;
  document.getElementById('group-chat-modal').style.display = 'flex';
  renderGroupMessages();
  document.getElementById('group-chat-input').focus();
}

function closeGroupChat() {
  document.getElementById('group-chat-modal').style.display = 'none';
  _activeGroupIdx = -1;
}

function renderGroupMessages() {
  if (_activeGroupIdx < 0) return;
  const g = _groups[_activeGroupIdx];
  const el = document.getElementById('group-chat-messages');
  if (g.messages.length === 0) {
    el.innerHTML = '<div class="msg msg-system">Nh\u00f3m \u0111\u00e3 s\u1eb5n s\u00e0ng. G\u1eedi tin nh\u1eafn v\u00e0 c\u00e1c agent s\u1ebd c\u00f9ng th\u1ea3o lu\u1eadn!</div>';
    return;
  }
  el.innerHTML = g.messages.map(m => {
    if (m.role === 'user') return `<div class="msg msg-user">${escHtml(m.content)}</div>`;
    if (m.role === 'system') return `<div class="msg msg-system">${escHtml(m.content)}</div>`;
    const icon = m.agent_role === 'coder' ? '\ud83d\udcbb' : m.agent_role === 'researcher' ? '\ud83d\udd2c' : m.agent_role === 'writer' ? '\u270d\ufe0f' : '\ud83e\udd16';
    return `<div class="msg msg-bot" style="border-left:3px solid var(--accent)">
      <div style="font-size:10px;color:var(--accent2);font-weight:600;margin-bottom:4px">${icon} ${m.agent}</div>
      <div>${escHtml(m.content)}</div>
    </div>`;
  }).join('');
  el.scrollTop = el.scrollHeight;
}

function escHtml(s) { return (s||'').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>'); }

async function sendGroupMessage() {
  if (_activeGroupIdx < 0) return;
  const input = document.getElementById('group-chat-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  
  const g = _groups[_activeGroupIdx];
  g.messages.push({ role: 'user', content: text, time: new Date().toISOString() });
  saveGroups();
  renderGroupMessages();
  
  // Send to each agent sequentially
  for (const agentName of g.agents) {
    // Build context with previous agent responses from this round
    const roundResponses = g.messages.filter(m => m.role === 'agent' && m.round === g.messages.length);
    const agentContext = `[Group "${g.name}" - Topic: ${g.topic}]
You are agent "${agentName}" in a group discussion. Here is the latest message:

User: ${text}

${roundResponses.map(m => m.agent + ': ' + m.content).join('\n')}

Contribute your perspective briefly (2-3 sentences) based on your expertise.`;

    // Show typing
    g.messages.push({ role: 'system', content: `\ud83e\udd16 ${agentName} \u0111ang suy ngh\u0129...`, _temp: true });
    saveGroups();
    renderGroupMessages();
    
    try {
      const res = await authFetch(API + `/api/v1/agents/${agentName}/chat`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message: agentContext })
      });
      const r = await res.json();
      // Remove typing indicator
      const tempIdx = g.messages.findIndex(m => m._temp && m.content.includes(agentName));
      if (tempIdx >= 0) g.messages.splice(tempIdx, 1);
      if (r.ok) {
        g.messages.push({ role: 'agent', agent: agentName, agent_role: r.role || 'assistant', content: r.response, time: new Date().toISOString(), round: g.messages.length });
      } else {
        g.messages.push({ role: 'agent', agent: agentName, agent_role: 'assistant', content: '\u274c ' + (r.error || 'Error'), time: new Date().toISOString() });
      }
    } catch(e) {
      const tempIdx2 = g.messages.findIndex(m => m._temp && m.content.includes(agentName));
      if (tempIdx2 >= 0) g.messages.splice(tempIdx2, 1);
      g.messages.push({ role: 'agent', agent: agentName, agent_role: 'assistant', content: '\u274c ' + e.message, time: new Date().toISOString() });
    }
    saveGroups();
    renderGroupMessages();
  }
  
  g.messages.push({ role: 'system', content: '\u2014\u2014 T\u1ea5t c\u1ea3 agent \u0111\u00e3 tr\u1ea3 l\u1eddi \u2014\u2014' });
  saveGroups();
  renderGroupMessages();
}

// â•â•â• KNOWLEDGE BASE â•â•â•
function showAddDocForm() { document.getElementById('kb-add-form').style.display = ''; }

async function loadKnowledgeDocs() {
  try {
    const res = await authFetch(API + '/api/v1/knowledge/documents');
    const data = await res.json();
    if (!data.ok) {
      document.getElementById('kb-doc-list').innerHTML = '<div style="color:var(--text2);padding:20px;text-align:center">Knowledge base not available. Check server logs.</div>';
      return;
    }
    
    document.getElementById('kb-docs').textContent = data.total_docs || 0;
    document.getElementById('kb-chunks').textContent = data.total_chunks || 0;
    
    const list = document.getElementById('kb-doc-list');
    if (!data.documents || data.documents.length === 0) {
      list.innerHTML = '<div style="color:var(--text2);padding:20px;text-align:center">No documents yet. Add knowledge for context-aware responses.</div>';
      return;
    }
    
    list.innerHTML = `<table style="width:100%;font-size:12px;border-collapse:collapse">
      <tr style="color:var(--text2);text-align:left;border-bottom:1px solid var(--border)">
        <th style="padding:8px">ID</th><th>Name</th><th>Source</th><th>Chunks</th><th></th>
      </tr>
      ${data.documents.map(d => `
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:6px">${d.id}</td>
          <td style="color:var(--accent2)">${d.name}</td>
          <td style="color:var(--text2)">${d.source}</td>
          <td>${d.chunks}</td>
          <td><button class="btn btn-outline btn-sm" onclick="removeDocument(${d.id})" style="font-size:10px;color:var(--red)">ğŸ—‘ï¸</button></td>
        </tr>
      `).join('')}
    </table>`;
  } catch(e) { console.error('Load KB:', e); }
}

async function searchKnowledge() {
  const query = document.getElementById('kb-search-input').value.trim();
  if (!query) return;
  
  const el = document.getElementById('kb-search-results');
  el.innerHTML = '<span style="color:var(--text2)">Searching...</span>';
  
  try {
    const res = await authFetch(API + '/api/v1/knowledge/search', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ query, limit: 5 })
    });
    const data = await res.json();
    if (!data.ok) { el.innerHTML = `<span style="color:var(--red)">âŒ ${data.error}</span>`; return; }
    
    if (data.results.length === 0) {
      el.innerHTML = '<span style="color:var(--text2)">No results found.</span>';
      return;
    }
    
    el.innerHTML = data.results.map(r => `
      <div style="margin-top:8px;padding:10px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:4px">
          <span>ğŸ“„ ${r.doc_name} (chunk ${r.chunk_idx})</span>
          <span>Score: ${(r.score || 0).toFixed(2)}</span>
        </div>
        <div style="font-size:12px;color:var(--text)">${(r.content || '').replace(/</g,'&lt;').substring(0, 300)}${(r.content||'').length > 300 ? '...' : ''}</div>
      </div>
    `).join('');
  } catch(e) { el.innerHTML = `<span style="color:var(--red)">âŒ ${e.message}</span>`; }
}

async function addDocument() {
  const name = document.getElementById('kb-doc-name').value.trim();
  const content = document.getElementById('kb-doc-content').value.trim();
  const source = document.getElementById('kb-doc-source').value.trim() || 'dashboard';
  if (!name || !content) { toast('Name and content are required', 'error'); return; }
  
  try {
    const res = await authFetch(API + '/api/v1/knowledge/documents', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name, content, source })
    });
    const r = await res.json();
    if (r.ok) {
      toast(`ğŸ“š Document added (${r.chunks} chunks)`);
      document.getElementById('kb-add-form').style.display = 'none';
      ['kb-doc-name','kb-doc-content'].forEach(id => document.getElementById(id).value = '');
      loadKnowledgeDocs();
    } else { toast('âŒ ' + r.error, 'error'); }
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

async function removeDocument(id) {
  try {
    const res = await authFetch(API + `/api/v1/knowledge/documents/${id}`, { method: 'DELETE' });
    const r = await res.json();
    toast(r.ok ? 'ğŸ—‘ï¸ Document removed' : 'âŒ ' + r.error);
    loadKnowledgeDocs();
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

// â•â•â• WEBSOCKET CHAT â•â•â•
let _wsReconnectAttempts = 0;
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  // Include pairing code in query param (WS doesn't support custom headers)
  const codeParam = pairingCode ? '?code=' + encodeURIComponent(pairingCode) : '';
  ws = new WebSocket(proto + '//' + location.host + '/ws' + codeParam);
  ws.onopen = () => {
    _wsReconnectAttempts = 0;
    document.getElementById('ws-status').innerHTML = 'ğŸŸ¢ ' + t('status.connected');
    // Send ping every 25s to keep alive
    if(window._wsPing) clearInterval(window._wsPing);
    window._wsPing = setInterval(() => { if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:'ping'})); }, 25000);
  };
  ws.onclose = (ev) => {
    document.getElementById('ws-status').innerHTML = 'ğŸ”´ ' + t('status.disconnected');
    if(window._wsPing) clearInterval(window._wsPing);
    // Exponential backoff reconnect (max 30s)
    _wsReconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(1.5, _wsReconnectAttempts), 30000);
    setTimeout(connectWS, delay);
  };
  ws.onerror = (ev) => {
    console.error('WS error:', ev);
  };
  ws.onmessage = (e) => {
    try { handleWS(JSON.parse(e.data)); } catch(err) { console.error('WS parse error:', err, e.data); }
  };
}

function handleWS(msg) {
  const el = document.getElementById('chat-messages');
  const typing = document.getElementById('chat-typing');
  switch(msg.type) {
    case 'connected':
      const agentStr = msg.agent_engine ? ' (Agent+Tools)' : ' (Direct)';
      addMsg(`ğŸŸ¢ Connected â€” ${msg.provider}/${msg.model}${agentStr}`, 'system');
      if (!msg.agent_engine) {
        addMsg('âš ï¸ Agent Engine not available. Chat will use direct provider calls (no tools/memory). Check Settings â†’ Provider config.', 'system');
      }
      break;
    case 'chat_start': typing.style.display = ''; break;
    case 'chat_chunk':
      typing.style.display = 'none';
      let s = el.querySelector('.msg-streaming');
      if (!s) { s = document.createElement('div'); s.className = 'msg msg-bot msg-streaming'; el.appendChild(s); }
      s.textContent += msg.content;
      el.scrollTop = el.scrollHeight;
      break;
    case 'chat_done':
      typing.style.display = 'none';
      const st = el.querySelector('.msg-streaming');
      if (st) st.classList.remove('msg-streaming');
      // Show context stats if available (from Agent engine)
      if (msg.context) {
        const ctx = msg.context;
        const ctxInfo = `ğŸ“Š ctx: ${ctx.estimated_tokens||0} tokens (${(ctx.utilization_pct||0).toFixed(1)}%) | ${ctx.message_count||0} msgs${ctx.last_tool_rounds ? ' | ğŸ”§ ' + ctx.last_tool_rounds + ' tool round(s)' : ''}${ctx.compacted ? ' | ğŸ“¦ compacted' : ''}`;
        addMsg(ctxInfo, 'system');
      }
      break;
    case 'chat_response': addMsg(msg.content, 'bot'); break;
    case 'chat_error':
      typing.style.display = 'none';
      const errMsg = msg.error || 'Unknown error';
      addMsg('âŒ ' + errMsg, 'system');
      // Show helpful hints for common errors
      if (errMsg.includes('Ollama') || errMsg.includes('connection failed')) {
        addMsg('ğŸ’¡ Tip: Make sure Ollama is running: ollama serve', 'system');
      } else if (errMsg.includes('API key') || errMsg.includes('401')) {
        addMsg('ğŸ’¡ Tip: Go to Settings â†’ API Key and enter your provider API key', 'system');
      } else if (errMsg.includes('Agent') || errMsg.includes('not available')) {
        addMsg('ğŸ’¡ Tip: Go to Settings â†’ choose a valid provider (e.g., Ollama or OpenAI) and save', 'system');
      }
      break;
    case 'status':
      addMsg(`ğŸ“Š Provider: ${msg.provider} | Model: ${msg.model} | Uptime: ${fmtUptime(msg.uptime_secs)} | Requests: ${msg.requests_processed} | Agent: ${msg.agent_engine ? 'âœ…' : 'âŒ'}`, 'system');
      break;
    case 'pong': break; // silent
    case 'error': addMsg('âš ï¸ ' + msg.message, 'system'); break;
  }
}

function sendChat() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text || !ws || ws.readyState !== 1) return;
  input.value = '';

  // Slash commands
  if (text === '/status') {
    ws.send(JSON.stringify({type:'status'}));
    addMsg('/status', 'user');
    return;
  }
  if (text === '/reset') {
    document.getElementById('chat-messages').innerHTML = '<div class="msg msg-system">' + t('chat.history_cleared') + '</div>';
    return;
  }
  if (text === '/help') {
    addMsg('/help', 'user');
    addMsg(t('chat.help'), 'system');
    return;
  }

  addMsg(text, 'user');
  ws.send(JSON.stringify({type:'chat',content:text,stream:true}));
}

function addMsg(text, role) {
  const el = document.createElement('div');
  el.className = 'msg msg-' + role;
  el.textContent = text;
  document.getElementById('chat-messages').appendChild(el);
  el.parentElement.scrollTop = el.parentElement.scrollHeight;
}

// â•â•â• HELPERS â•â•â•
function fmtUptime(s) {
  if (!s) return 'â€”';
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
  return h + 'h ' + m + 'm';
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// â•â•â• i18n â•â•â•
let currentLang = localStorage.getItem('bizclaw_lang') || 'vi';
const I18N = {
  vi: {
    // Navigation
    'nav.dashboard':'Báº£ng Ä‘iá»u khiá»ƒn','nav.webchat':'TrÃ² chuyá»‡n','nav.settings':'CÃ i Ä‘áº·t',
    'nav.providers':'NhÃ  cung cáº¥p','nav.channels':'KÃªnh liÃªn láº¡c','nav.tools':'CÃ´ng cá»¥','nav.groups':'NhÃ³m Agent',
    'nav.brain':'Brain Engine','nav.mcp':'MÃ¡y chá»§ MCP','nav.agents':'Äa tÃ¡c tá»­',
    'nav.knowledge':'Kho tri thá»©c','nav.config':'Tá»‡p cáº¥u hÃ¬nh',
    // Dashboard
    'dash.title':'Báº£ng Ä‘iá»u khiá»ƒn','dash.subtitle':'Trung tÃ¢m quáº£n lÃ½ Agent Gateway',
    'dash.status':'Tráº¡ng thÃ¡i','dash.version':'PhiÃªn báº£n','dash.provider':'NhÃ  cung cáº¥p',
    'dash.model':'MÃ´ hÃ¬nh AI','dash.uptime':'Thá»i gian hoáº¡t Ä‘á»™ng','dash.platform':'Ná»n táº£ng',
    'dash.channels':'KÃªnh Ä‘ang hoáº¡t Ä‘á»™ng','dash.clock':'Äá»“ng há»“','dash.system':'Há»‡ thá»‘ng',
    'dash.online':'Trá»±c tuyáº¿n','dash.quickactions':'Thao tÃ¡c nhanh',
    'sys.os':'Há»‡ Ä‘iá»u hÃ nh:','sys.arch':'Kiáº¿n trÃºc:','sys.memory':'Bá»™ nhá»›:',
    // Table headers
    'th.channel':'KÃªnh','th.type':'Loáº¡i','th.status':'Tráº¡ng thÃ¡i','th.configured':'ÄÃ£ cáº¥u hÃ¬nh',
    // Chat
    'chat.title':'TrÃ² chuyá»‡n','chat.welcome':'ÄÃ£ káº¿t ná»‘i BizClaw. Nháº­p tin nháº¯n Ä‘á»ƒ báº¯t Ä‘áº§u trÃ² chuyá»‡n.',
    'chat.thinking':'BizClaw Ä‘ang suy nghÄ©','chat.placeholder':'Nháº­p tin nháº¯n...','chat.send':'Gá»­i â†‘',
    'chat.history_cleared':'ğŸ’¬ ÄÃ£ xÃ³a lá»‹ch sá»­ trÃ² chuyá»‡n',
    'chat.help':'Lá»‡nh cÃ³ sáºµn:\n/status â€” Xem tráº¡ng thÃ¡i agent\n/reset â€” XÃ³a lá»‹ch sá»­ chat\n/help â€” Hiá»‡n trá»£ giÃºp',
    // Status
    'status.connected':'ÄÃ£ káº¿t ná»‘i','status.disconnected':'ÄÃ£ ngáº¯t káº¿t ná»‘i',
    // Settings
    'settings.title':'CÃ i Ä‘áº·t Agent','settings.subtitle':'Cáº¥u hÃ¬nh AI agent â€” nhÃ  cung cáº¥p, mÃ´ hÃ¬nh, danh tÃ­nh, báº£o máº­t',
    'settings.save':'ğŸ’¾ LÆ°u cÃ i Ä‘áº·t',
    'set.provider_section':'NhÃ  cung cáº¥p AI','set.provider':'NhÃ  cung cáº¥p','set.model':'MÃ´ hÃ¬nh',
    'set.apikey':'KhÃ³a API','set.baseurl':'URL API tÃ¹y chá»‰nh','set.loading_models':'Äang táº£i mÃ´ hÃ¬nh...','set.model_path':'ÄÆ°á»ng dáº«n mÃ´ hÃ¬nh',
    'set.scan':'QuÃ©t','set.threads':'Luá»“ng xá»­ lÃ½','set.temperature':'Nhiá»‡t Ä‘á»™',
    'set.identity':'Danh tÃ­nh','set.agent_name':'TÃªn Agent','set.persona':'Vai trÃ²',
    'set.sysprompt':'Lá»i nháº¯c há»‡ thá»‘ng','set.memory':'Bá»™ nhá»›','set.backend':'Backend',
    'set.autosave':'Tá»± Ä‘á»™ng lÆ°u','set.security':'Báº£o máº­t / Quyá»n tá»± chá»§',
    'set.autonomy':'Má»©c tá»± chá»§','set.readonly':'Chá»‰ Ä‘á»c','set.supervised':'GiÃ¡m sÃ¡t',
    'set.full':'ToÃ n quyá»n','set.workspace_only':'Chá»‰ Workspace',
    // Providers
    'providers.title':'NhÃ  cung cáº¥p','providers.subtitle':'Cáº¥u hÃ¬nh nhÃ  cung cáº¥p AI â€” chá»n provider máº·c Ä‘á»‹nh, API key, model',
    'providers.active_label':'Provider Ä‘ang dÃ¹ng','providers.total_label':'Tá»•ng providers',
    'providers.type_cloud':'Cloud','providers.type_local':'Ná»™i bá»™','providers.type_proxy':'Proxy',
    'providers.badge_active':'Äang dÃ¹ng','providers.btn_activate':'âš¡ KÃ­ch hoáº¡t','providers.btn_active':'âœ… Äang sá»­ dá»¥ng',
    // Channels
    'channels.title':'Cáº¥u hÃ¬nh kÃªnh liÃªn láº¡c','channels.subtitle':'Káº¿t ná»‘i agent vá»›i cÃ¡c ná»n táº£ng nháº¯n tin',
    // Tools
    'tools.title':'CÃ´ng cá»¥','tools.subtitle':'12 cÃ´ng cá»¥ tÃ­ch há»£p + cÃ´ng cá»¥ MCP bÃªn ngoÃ i',
    'tool.active':'Hoáº¡t Ä‘á»™ng','tool.available':'Sáºµn sÃ ng',
    'tool.file':'Tá»‡p tin','tool.editfile':'Sá»­a tá»‡p','tool.websearch':'TÃ¬m kiáº¿m Web',
    'tool.calendar':'Lá»‹ch','tool.docreader':'Äá»c tÃ i liá»‡u','tool.summarizer':'TÃ³m táº¯t nhÃ³m',
    'tool.httpreq':'HTTP Request','tool.configmgr':'Quáº£n lÃ½ cáº¥u hÃ¬nh','tool.memsearch':'TÃ¬m trÃ­ nhá»›',
    'tool.shell_desc':'Thá»±c thi lá»‡nh há»‡ thá»‘ng (sandbox)','tool.file_desc':'Äá»c/ghi/liá»‡t kÃª tá»‡p tin',
    'tool.editfile_desc':'Thay tháº¿ chÃ­nh xÃ¡c ná»™i dung trong tá»‡p',
    'tool.glob_desc':'TÃ¬m tá»‡p theo máº«u (*.rs, **/*.toml)',
    'tool.grep_desc':'TÃ¬m ná»™i dung trong tá»‡p báº±ng regex',
    'tool.httpreq_desc':'Gá»i API bÃªn ngoÃ i (GET/POST/PUT/DELETE)',
    'tool.configmgr_desc':'Äá»c/ghi config.toml lÃºc runtime',
    'tool.memsearch_desc':'TÃ¬m há»™i thoáº¡i cÅ© báº±ng FTS5',
    'tool.execcode':'Cháº¡y mÃ£','tool.execcode_desc':'Cháº¡y code Python, JS, Go, Rust, C...',
    'tool.plan':'Káº¿ hoáº¡ch','tool.plan_desc':'PhÃ¢n rÃ£ tÃ¡c vá»¥ vá»›i phá»¥ thuá»™c vÃ  Ä‘á»™ phá»©c táº¡p',
    'tool.sessionctx':'Ngá»¯ cáº£nh phiÃªn','tool.sessionctx_desc':'ThÃ´ng tin phiÃªn: provider, token, tools',
    'tool.calendar_desc':'TÃ­ch há»£p Google Calendar','tool.docreader_desc':'TrÃ­ch xuáº¥t PDF, DOCX, Excel, CSV',
    'tool.summarizer_desc':'TÃ³m táº¯t tin nháº¯n nhÃ³m Zalo/Telegram',
    'tools.subtitle':'15 cÃ´ng cá»¥ tÃ­ch há»£p + cÃ´ng cá»¥ MCP bÃªn ngoÃ i',
    // MCP
    'mcp.title':'MÃ¡y chá»§ MCP','mcp.subtitle':'Model Context Protocol â€” má»Ÿ rá»™ng agent vá»›i cÃ´ng cá»¥ bÃªn ngoÃ i',
    'mcp.add':'ThÃªm mÃ¡y chá»§','mcp.total':'Tá»•ng mÃ¡y chá»§','mcp.active':'Äang hoáº¡t Ä‘á»™ng',
    'mcp.protocol':'Giao thá»©c','mcp.add_title':'ThÃªm mÃ¡y chá»§ MCP','mcp.popular':'MCP phá»• biáº¿n',
    // Multi-Agent
    'agents.title':'Äa tÃ¡c tá»­ AI','agents.subtitle':'Táº¡o vÃ  quáº£n lÃ½ nhiá»u agent AI vá»›i vai trÃ² khÃ¡c nhau',
    'agents.create':'Táº¡o Agent','agents.total':'Tá»•ng Agent','agents.default':'Agent máº·c Ä‘á»‹nh',
    'agents.messages':'Tin nháº¯n','agents.create_new':'Táº¡o Agent má»›i','agents.broadcast':'PhÃ¡t tin nháº¯n',
    'agents.msg':'Tin nháº¯n','agents.send_all':'Gá»­i táº¥t cáº£',
    // Agent Groups
    'groups.title':'NhÃ³m Agent','groups.subtitle':'Táº¡o nhÃ³m cÃ¡c Agent AI cÃ¹ng trao Ä‘á»•i vÃ  phá»‘i há»£p â€” nhÆ° OpenClaw',
    'groups.create':'Táº¡o nhÃ³m','groups.total':'Tá»•ng nhÃ³m','groups.agents_count':'Agent trong nhÃ³m',
    'groups.conversations':'Cuá»™c há»™i thoáº¡i','groups.create_new':'Táº¡o nhÃ³m má»›i',
    'groups.topic':'Chá»§ Ä‘á»','groups.select_agents':'Chá»n Agent tham gia:',
    'groups.agent_hint':'ChÆ°a cÃ³ agent? VÃ o trang Äa tÃ¡c tá»­ Ä‘á»ƒ táº¡o trÆ°á»›c.',
    // Knowledge Base
    'kb.title':'Kho tri thá»©c','kb.subtitle':'RAG cÃ¡ nhÃ¢n â€” thÃªm tÃ i liá»‡u Ä‘á»ƒ AI tráº£ lá»i chÃ­nh xÃ¡c hÆ¡n',
    'kb.add_doc':'ThÃªm tÃ i liá»‡u','kb.documents':'TÃ i liá»‡u','kb.chunks':'Äoáº¡n vÄƒn',
    'kb.search_engine':'CÃ´ng cá»¥ tÃ¬m kiáº¿m','kb.search':'TÃ¬m kiáº¿m tri thá»©c','kb.search_btn':'TÃ¬m kiáº¿m',
    'kb.add_title':'ThÃªm tÃ i liá»‡u','kb.source':'Nguá»“n','kb.content':'Ná»™i dung',
    'kb.doc_list':'Danh sÃ¡ch tÃ i liá»‡u',
    // Brain Engine
    'brain.title':'Brain Engine','brain.engine':'Äá»™ng cÆ¡','brain.quant':'LÆ°á»£ng tá»­ hÃ³a',
    'brain.features':'TÃ­nh nÄƒng','brain.models':'MÃ´ hÃ¬nh cÃ³ sáºµn','brain.size':'KÃ­ch thÆ°á»›c',
    'brain.download':'Táº£i vá»','brain.ws_sub':'Workspace nÃ£o, tá»‡p tÃ­nh cÃ¡ch vÃ  kiá»ƒm tra sá»©c khá»e há»‡ thá»‘ng',
    'brain.health_btn':'Kiá»ƒm tra sá»©c khá»e','brain.health_title':'Kiá»ƒm tra sá»©c khá»e há»‡ thá»‘ng',
    'brain.check_name':'Kiá»ƒm tra','brain.check_status':'Tráº¡ng thÃ¡i','brain.check_detail':'Chi tiáº¿t',
    'brain.ws_title':'Workspace NÃ£o','brain.new_file':'Tá»‡p má»›i','brain.save':'LÆ°u',
    'brain.files_count':'Brain Files',
    // Forms
    'form.name':'TÃªn','form.command':'Lá»‡nh','form.args':'Tham sá»‘ (phÃ¢n cÃ¡ch báº±ng dáº¥u pháº©y)',
    'form.env':'Biáº¿n mÃ´i trÆ°á»ng (KEY=VALUE, má»—i dÃ²ng má»™t cáº·p)','form.save':'LÆ°u','form.cancel':'Há»§y',
    'form.role':'Vai trÃ²','form.description':'MÃ´ táº£',
    // Config page
    'config.title':'config.toml',
    // Onboarding
    'onboard.welcome_sub':'HÃ£y Ä‘á»ƒ AI táº¡o má»™t trá»£ lÃ½ phÃ¹ há»£p riÃªng cho báº¡n. Chá»‰ máº¥t 30 giÃ¢y.',
    'onboard.your_name':'TÃªn báº¡n','onboard.about_you':'Báº¡n lÃ  ai, lÃ m gÃ¬?',
    'onboard.agent_vibe':'Phong cÃ¡ch Agent',
    'onboard.provider_sub':'Chá»n nguá»“n AI. KhÃ´ng cáº§n API key? DÃ¹ng Ollama hoáº·c Brain Engine.',
    'onboard.done_title':'Agent Ä‘Ã£ sáºµn sÃ ng!',
    'onboard.done_sub':'AI Ä‘ang táº¡o tÃ­nh cÃ¡ch riÃªng cho agent cá»§a báº¡n...',
    // Pairing
    'pairing.title':'BizClaw Agent','pairing.desc':'Nháº­p mÃ£ Pairing Code Ä‘á»ƒ truy cáº­p Dashboard',
    'pairing.confirm':'ğŸ”“ XÃ¡c nháº­n','pairing.error':'Vui lÃ²ng nháº­p mÃ£ pairing',
  },
  en: {
    // Navigation
    'nav.dashboard':'Dashboard','nav.webchat':'WebChat','nav.settings':'Settings',
    'nav.providers':'Providers','nav.channels':'Channels','nav.tools':'Tools','nav.groups':'Agent Groups',
    'nav.brain':'Brain Engine','nav.mcp':'MCP Servers','nav.agents':'Multi-Agent',
    'nav.knowledge':'Knowledge','nav.config':'Config File',
    // Dashboard
    'dash.title':'Dashboard','dash.subtitle':'Agent Gateway Control Panel',
    'dash.status':'Status','dash.version':'Version','dash.provider':'Provider',
    'dash.model':'AI Model','dash.uptime':'Uptime','dash.platform':'Platform',
    'dash.channels':'Active Channels','dash.clock':'Clock','dash.system':'System',
    'dash.online':'Online','dash.quickactions':'Quick Actions',
    'sys.os':'OS:','sys.arch':'Arch:','sys.memory':'Memory:',
    // Table headers
    'th.channel':'Channel','th.type':'Type','th.status':'Status','th.configured':'Configured',
    // Chat
    'chat.title':'WebChat','chat.welcome':'Connected to BizClaw. Type a message to start chatting.',
    'chat.thinking':'BizClaw is thinking','chat.placeholder':'Type your message...','chat.send':'Send â†‘',
    'chat.history_cleared':'ğŸ’¬ Chat history cleared',
    'chat.help':'Available commands:\n/status â€” Show agent status\n/reset â€” Clear chat history\n/help â€” Show this help',
    // Status
    'status.connected':'Connected','status.disconnected':'Disconnected',
    // Settings
    'settings.title':'Agent Settings','settings.subtitle':'Configure your AI agent â€” provider, model, identity, security',
    'settings.save':'ğŸ’¾ Save Settings',
    'set.provider_section':'AI Provider','set.provider':'Provider','set.model':'Model',
    'set.apikey':'API Key','set.baseurl':'Custom API Base URL','set.loading_models':'Loading models...','set.model_path':'Model Path',
    'set.scan':'Scan','set.threads':'Threads','set.temperature':'Temperature',
    'set.identity':'Identity','set.agent_name':'Agent Name','set.persona':'Persona',
    'set.sysprompt':'System Prompt','set.memory':'Memory','set.backend':'Backend',
    'set.autosave':'Auto Save','set.security':'Security / Autonomy',
    'set.autonomy':'Autonomy Level','set.readonly':'Read Only','set.supervised':'Supervised',
    'set.full':'Full','set.workspace_only':'Workspace Only',
    // Providers
    'providers.title':'Providers','providers.subtitle':'Configure AI providers â€” set default provider, API key, model',
    'providers.active_label':'Active Provider','providers.total_label':'Total Providers',
    'providers.type_cloud':'Cloud','providers.type_local':'Local','providers.type_proxy':'Proxy',
    'providers.badge_active':'Active','providers.btn_activate':'âš¡ Activate','providers.btn_active':'âœ… In Use',
    // Channels
    'channels.title':'Channel Configuration','channels.subtitle':'Connect your agent to messaging platforms',
    // Tools
    'tools.title':'Tools','tools.subtitle':'12 built-in tools + external MCP tools',
    'tool.active':'Active','tool.available':'Available',
    'tool.file':'File','tool.editfile':'Edit File','tool.websearch':'Web Search',
    'tool.calendar':'Calendar','tool.docreader':'Document Reader','tool.summarizer':'Group Summarizer',
    'tool.httpreq':'HTTP Request','tool.configmgr':'Config Manager','tool.memsearch':'Memory Search',
    'tool.shell_desc':'Execute system commands (sandboxed)','tool.file_desc':'Read/write/list files',
    'tool.editfile_desc':'Precise text replacements in files',
    'tool.glob_desc':'Find files by pattern (*.rs, **/*.toml)',
    'tool.grep_desc':'Search file contents with regex',
    'tool.httpreq_desc':'Call external APIs (GET/POST/PUT/DELETE)',
    'tool.configmgr_desc':'Read/write config.toml at runtime',
    'tool.memsearch_desc':'Search past conversations via FTS5',
    'tool.execcode':'Execute Code','tool.execcode_desc':'Run Python, JS, Go, Rust, C code...',
    'tool.plan':'Plan Mode','tool.plan_desc':'Task decomposition with dependencies & complexity',
    'tool.sessionctx':'Session Context','tool.sessionctx_desc':'Session info: provider, tokens, tools',
    'tool.calendar_desc':'Google Calendar integration','tool.docreader_desc':'PDF, DOCX, Excel, CSV extraction',
    'tool.summarizer_desc':'Zalo/Telegram group message summary',
    'tools.subtitle':'15 built-in tools + external MCP tools',
    // MCP
    'mcp.title':'MCP Servers','mcp.subtitle':'Model Context Protocol â€” extend your agent with external tools',
    'mcp.add':'Add Server','mcp.total':'Total Servers','mcp.active':'Active',
    'mcp.protocol':'Protocol','mcp.add_title':'Add MCP Server','mcp.popular':'Popular MCP Servers',
    // Multi-Agent
    'agents.title':'Multi-Agent AI','agents.subtitle':'Create and manage multiple AI agents with different roles',
    'agents.create':'Create Agent','agents.total':'Total Agents','agents.default':'Default Agent',
    'agents.messages':'Messages','agents.create_new':'Create New Agent','agents.broadcast':'Broadcast Message',
    'agents.msg':'Message','agents.send_all':'Send to All',
    // Agent Groups
    'groups.title':'Agent Groups','groups.subtitle':'Create groups of AI Agents to discuss and collaborate â€” like OpenClaw',
    'groups.create':'Create Group','groups.total':'Total Groups','groups.agents_count':'Agents in Groups',
    'groups.conversations':'Conversations','groups.create_new':'Create New Group',
    'groups.topic':'Topic','groups.select_agents':'Select Agents:',
    'groups.agent_hint':'No agents yet? Go to Multi-Agent page to create some first.',
    // Knowledge Base
    'kb.title':'Knowledge Base','kb.subtitle':'Personal RAG â€” add documents for context-aware AI responses',
    'kb.add_doc':'Add Document','kb.documents':'Documents','kb.chunks':'Chunks',
    'kb.search_engine':'Search Engine','kb.search':'Search Knowledge','kb.search_btn':'Search',
    'kb.add_title':'Add Document','kb.source':'Source','kb.content':'Content',
    'kb.doc_list':'Document List',
    // Brain Engine
    'brain.title':'Brain Engine','brain.engine':'Engine','brain.quant':'Quantization',
    'brain.features':'Features','brain.models':'Available Models','brain.size':'Size',
    'brain.download':'Download','brain.ws_sub':'Brain workspace, personality files, and system health check',
    'brain.health_btn':'Health Check','brain.health_title':'System Health Check',
    'brain.check_name':'Check','brain.check_status':'Status','brain.check_detail':'Detail',
    'brain.ws_title':'Brain Workspace','brain.new_file':'New File','brain.save':'Save',
    'brain.files_count':'Brain Files',
    // Forms
    'form.name':'Name','form.command':'Command','form.args':'Arguments (comma-separated)',
    'form.env':'Environment Variables (KEY=VALUE, one per line)','form.save':'Save','form.cancel':'Cancel',
    'form.role':'Role','form.description':'Description',
    // Config page
    'config.title':'config.toml',
    // Onboarding
    'onboard.welcome_sub':'Let AI create a personalized assistant just for you. Only takes 30 seconds.',
    'onboard.your_name':'Your Name','onboard.about_you':'Who are you, what do you do?',
    'onboard.agent_vibe':'Agent Personality',
    'onboard.provider_sub':'Choose your AI source. No API key? Use Ollama or Brain Engine.',
    'onboard.done_title':'Agent is Ready!',
    'onboard.done_sub':'AI is creating a unique personality for your agent...',
    // Pairing
    'pairing.title':'BizClaw Agent','pairing.desc':'Enter Pairing Code to access Dashboard',
    'pairing.confirm':'ğŸ”“ Confirm','pairing.error':'Please enter pairing code',
  }
};
function t(key){ return (I18N[currentLang]||I18N.vi)[key] || (I18N.vi[key]) || key; }
function setLang(lang){
  currentLang = lang;
  localStorage.setItem('bizclaw_lang', lang);
  document.getElementById('btn-vi').style.background = lang==='vi' ? 'var(--accent)' : 'transparent';
  document.getElementById('btn-vi').style.color = lang==='vi' ? '#fff' : 'var(--text2)';
  document.getElementById('btn-en').style.background = lang==='en' ? 'var(--accent)' : 'transparent';
  document.getElementById('btn-en').style.color = lang==='en' ? '#fff' : 'var(--text2)';
  // Update all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.getAttribute('data-i18n'));
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });
  // Re-render dynamic cards with new language
  if (configData && configData.default_provider) renderProviderCards();
  // Update WS status
  if(ws && ws.readyState === 1) {
    document.getElementById('ws-status').innerHTML = 'ğŸŸ¢ ' + t('status.connected');
  } else {
    document.getElementById('ws-status').innerHTML = 'ğŸ”´ ' + t('status.disconnected');
  }
}

// â•â•â• INIT â•â•â•
async function initApp(){
  setLang(currentLang);
  await loadConfig(); // Load config FIRST so settings form has data
  routeFromPath();
  loadDashboard();
  loadProviders();
  connectWS();
  setInterval(loadDashboard, 15000);
}
checkPairing();
</script>
</body>
</html>
